<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Bina PlanÄ±</title>  
    <link rel="icon" type="image/png" href="img/icon.png" sizes="32x32">
    <!-- Bootstrap CSS -->  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>  

<style>  
    
body {
  min-height: 130vh;
  height: 110%;
  margin: 0;
  background: linear-gradient(to bottom, #fff, #dbeafe 75%);
}
.city-silhouette {
  position: fixed;   /* absolute deÄŸil, fixed! */
  left: 0; right: 0; bottom: 0;
  width: 100vw;
  height: 24vh;
  min-height: 100px;
  max-height: 220px;
  pointer-events: none;
  opacity: 0.5;
}
.main-content {
    position: relative;
}
.frost {
    backdrop-filter: blur(8px) brightness(0.96);
}

/* ---- KÄ±sa MenÃ¼ BarÄ± ---- */
.custom-short-menu {
  display: flex;
  gap: 22px;
  justify-content: center;
  align-items: flex-start;
  width: 100%;
  margin: 18px 0 10px 0;
}
.menu-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 70px;
  text-decoration: none;
  background: none;
  border: none;
  transition: color 0.18s, background 0.18s;
  cursor: pointer;
  outline: none;
}
.menu-btn img {
  width: 32px;
  height: 32px;
  margin-bottom: 4px;
}
.menu-btn span {
  font-size: 14px;
  color: #333;
}
.menu-btn:hover span, .menu-btn:focus span {
  color: #1d67c4;
  font-weight: 500;
}
#buttonHome { margin-right: 18px; }

/* ---- Navbar ve ProjectName (sol Ã¼st) ---- */
.container-fluid {
  display: flex;
  flex: 0 0 100%;
  flex-wrap: nowrap;
  align-items: center;
}
#projectName {
  flex: 0 0 90%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-family: Arial, sans-serif;
  font-size: 36px;
}
.img-fluid {
  flex: 0 0 auto;
  height: 30px;
  width: 30px;
  margin-right: 10px;
}

/* ---- Butonlar ---- */
.custom-btn {
  background-color: #847539;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 10px 20px;
  font-family: "Varela Round";
  font-size: 16px;
  font-weight: bold;
  letter-spacing: 2px;
  cursor: pointer;
  transition: background-color 0.3s;
  margin-right: 40px;
}
.custom-btn:hover, .custom-btn:focus {
  background-color: #67552A;
}

/* ---- SÃ¼reÃ§ BaÅŸlÄ±ÄŸÄ± ---- */
.surec-title {
  font-family: 'Oswald', sans-serif;
  font-size: 2.1rem;
  font-weight: bold;
  text-align: center;
  color: #67552A;
  margin: 32px 0 36px 0;
}

/* ---- SÃ¼reÃ§ AdÄ±mlarÄ± (Yatay Tab Bar) ---- */
.flow-steps-container {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
  gap: 0.5em;
  padding: 1.25em 0 2em 0;
}
.flow-step-btn {
  font-family: inherit;
  background: #fff;
  color: #333;
  border: 2px solid #e2e8f0;
  border-radius: 2.4em;
  font-weight: 500;
  font-size: 1.18em;
  padding: 0.88em 2.3em;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 8px 0 #e5ecf7;
  transition: color 0.14s, background 0.16s, border-color 0.16s;
  outline: none;
  position: relative;
  min-width: 176px;
}
.flow-step-btn.active, .flow-step-btn:focus {
  background: linear-gradient(90deg, #2563eb 0%, #60a5fa 70%);
  color: #fff;
  border-color: #468ef9;
  box-shadow: 0 4px 16px 0 #cbd9fd;
  z-index: 1;
}
.flow-step-arrow {
  display: flex;
  align-items: center;
  height: 30px;
}
.flow-step-arrow svg {
  display: block;
  width: 28px;
  height: 30px;
  stroke: #d1d5db;
  stroke-width: 2.5;
  fill: none;
}

/* ---- Evrak Ä°ÅŸleri (Accordion KutularÄ±) ---- */
.surec-section { display: none; }
.surec-section.active { display: block; animation: fadein 0.5s; }
@keyframes fadein {
  from { opacity: 0; transform: translateY(20px);}
  to { opacity: 1; transform: translateY(0);}
}
.bolum-baslik {
  font-family: 'Oswald', sans-serif;
  font-size: 1.26rem;
  color: #5b74e6;
  font-weight: 700;
  margin-bottom: 1.2rem;
  letter-spacing: 0.5px;
  text-align: center;
  margin-top: 4px;
}
.alt-kutu-icerik { 
  display: none; 
}
.alt-baslik-kutu[aria-expanded="true"] + .alt-kutu-icerik { 
  display: block; 
}
.er-kutular {
  width: 100%;
  max-width: 750px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 1.1rem;
}
.alt-baslik-ikon{
  margin-left: 20px;
  margin-right: 10px;
}
.alt-baslik-kutu {
  background: linear-gradient(90deg, #f7ecd2 0%, #e3e7fa 100%);
  border-radius: 1.4rem;
  box-shadow: 0 4px 14px 0 rgba(160,160,160,0.07);
  padding: 1.0rem 1.25rem 1.08rem 1.31rem;
  border: none;
  display: flex;
  width: 100%;
  cursor: pointer;
  position: relative;
  font-family: 'Oswald', Arial, sans-serif;
  font-size: 1.07rem;
  font-weight: 700;
  color: #2c2c21;
  transition: background .18s, box-shadow .18s, color .17s;
  text-align: left;
}
.alt-baslik-kutu:hover, .alt-baslik-kutu:focus {
  background: linear-gradient(90deg, #f2e5be 0%, #cbd8f3 100%);
  color: #2857ad;
  box-shadow: 0 8px 22px 0 rgba(120,140,190,0.12);
  outline: none;
}
.alt-kutu-arrow {
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%) rotate(0deg);
  transition: transform .25s cubic-bezier(.43,1.16,.45,1.13);
  font-size: 1.08em;
  pointer-events: none;
  color: #caad2e;
}
.alt-baslik-kutu[aria-expanded="true"] .alt-kutu-arrow {
  transform: translateY(-50%) rotate(90deg);
  color: #4a75e0;
}
.alt-kutu-icerik {
  background: #f7ecd2;
  border-radius: 0 0 1rem 1rem;
  margin-top: -6px;
  box-shadow: 0 2px 8px 0 rgba(180,180,180,0.08);
  padding: 0.7rem 1.7rem 1.08rem 1.7rem;
  animation: fadein .4s;
  width: 100%;
}
.alt-kutu-icerik ul { margin-bottom: 0; }
.alt-kutu-icerik li {
  font-family: "Varela Round", Arial, sans-serif;
  font-size: 1rem;
  color: #312e21;
  margin-bottom: 0.43rem;
}

/* ---- Evrak Ekle Butonu ---- */
.evrak-ekle-btn {
  display: block;
  margin: 50px auto 0 auto;
  font-family: "Oswald", Arial, sans-serif;
  font-size: 1.15rem;
  background: linear-gradient(90deg, #e3e7fa 0%, #f7ecd2 100%);
  border-radius: 14px;
  border: none;
  color: #3560bd;
  padding: 0.8rem 1.7rem;
  font-weight: 700;
  box-shadow: 0 2px 10px 0 rgba(180,180,180,0.10);
  transition: background .2s, color .2s, box-shadow .14s;
  letter-spacing: 1px;
}
.evrak-ekle-btn:hover, .evrak-ekle-btn:focus {
  background: linear-gradient(90deg, #f7ecd2 0%, #e3e7fa 100%);
  color: #1d4188;
  box-shadow: 0 4px 17px 1px rgba(80,100,200,0.13);
  outline: none;
}

/* ---- Ãœretim AdÄ±mlarÄ± KutularÄ± ---- */
.uretim-steps-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  justify-content: center;
  margin: 20px 0 0 0;
}
.uretim-step-btn {
  background: linear-gradient(90deg, #f7ecd2 0%, #e3e7fa 100%);
  color: #2c2c21;
  border-radius: 16px;                           /* Daha yuvarlak */
  border: none;
  font-family: 'Oswald', Arial, sans-serif;
  font-size: 1.15rem;                            /* Font bÃ¼yÃ¼dÃ¼ */
  font-weight: 700;
  padding: 0.56rem 2rem;                         /* Ãœst-alt ve saÄŸ-sol padding arttÄ± */
  transition: background .14s, color .13s, box-shadow .14s;
  box-shadow: 0 4px 14px 0 rgba(120,140,190,0.12); /* GÃ¶lge biraz gÃ¼Ã§lendi */
  cursor: pointer;
  margin: 8px 0;                                /* Dikey aralÄ±k arttÄ± */
  position: relative;
  white-space: nowrap;
}
.uretim-step-btn:hover, .uretim-step-btn:focus {
  background: linear-gradient(90deg, #f2e5be 0%, #cbd8f3 100%);
  color: #3560bd;
  box-shadow: 0 6px 18px 0 rgba(120,140,190,0.17);
  outline: none;
}
.uretim-step-ok {
  display: flex;
  align-items: center;
  margin: 0 3px;
  z-index: 1;
}
.uretim-step-ok svg {
  width: 34px;
  height: 14px;
  color: #d6b739;
  stroke-width: 5px;
  stroke: #d6b739;
  fill: none;
  vertical-align: middle;
}
#tab-uretim .bolum-baslik {
  font-family: 'Oswald',sans-serif;
  font-size:2.2rem;
  color: #3560bd;
  font-weight: 800;
  border-radius: 18px;
  padding: 1.2em 1.3em .9em 1.3em;
  margin-bottom:2.2rem;
  box-shadow:0 6px 36px 0 rgba(44, 83, 180, 0.10);
  text-align:center;
  text-shadow:0 2px 8px #e6eefd;
  letter-spacing:.03em;
}
.bolum-baslik {
  background: none;
  box-shadow: none;
}
/* Soft glassy tablar */
.uretim-tabs-row {
  display:flex; gap:15px; justify-content:center; margin-bottom:1.6rem;
  flex-wrap:wrap;
}
.uretim-tab-btn {
  position: relative;
  appearance: none;
  outline: none;
  border: none;
  font-family: 'Oswald', Arial, sans-serif;
  font-size: 0.97rem;                     /* Font daha kÃ¼Ã§Ã¼k */
  font-weight: 700;
  padding: .62em 1.4em .62em 1.7em;       /* Ãœst-alt ve saÄŸ-sol padding azaldÄ± */
  border-radius: 14px;                    /* KÃ¶ÅŸe biraz kÃ¼Ã§Ã¼ldÃ¼ */
  background: linear-gradient(92deg, #f0f9ff 0%, #dbeafe 60%, #bae6fd 100%);
  color: #446398;
  box-shadow: 0 2px 8px 0 #bcdffd44;      /* GÃ¶lge daha yumuÅŸak */
  backdrop-filter: blur(7px) saturate(130%);
  transition: all .18s cubic-bezier(.47,1.7,.39,.88);
  letter-spacing: .07em;
  border: 1.4px solid #dbeafe;           /* KenarlÄ±k inceldi */
  margin-bottom: 0;
  cursor: pointer;
  min-width: 86px;                        /* Minimum geniÅŸlik daha az */
  display: flex;
  gap: .4em;
  align-items: center;
}

.uretim-tab-btn:hover,
.uretim-tab-btn:focus {
  color: #fff;
  background: linear-gradient(98deg, #60a5fa 0%, #38bdf8 94%);
  box-shadow: 0 8px 28px 0 #60a5fa33, 0 2px 8px #2563eb19;
  border-color: #38bdf8;
}

.uretim-tab-btn:focus,
.uretim-tab-btn:active,
.uretim-tab-btn:focus-visible {
  outline: none !important;
  box-shadow: none !important;
  color: #000000;
}
.uretim-tab-btn .uretim-ikon {
  font-size:1.27em; 
  opacity:.82;
  margin-right:.25em;
  margin-top:-2px;
  display:inline-block;
  filter:drop-shadow(0 1px 0 #eef6ff77);
}

/* ---- Modal ve File List ---- */
.modal-xl { --bs-modal-width:950px; }
#modalUretim .file-list { max-height:180px; overflow:auto; }

#geriRadyalBtn {
  float: none !important;     /* Bootstrap float'Ä± devreden Ã§Ä±kar */
  display: block;             /* Tam satÄ±r kaplasÄ±n */
  margin-left: 0;
  margin-bottom: 8px;
}
#modalContentGenel > .row {
  justify-content: center !important;
}


/* ---- Responsive Break Points ---- */
@media (max-width:820px){
  .uretim-steps-row { flex-wrap: wrap; }
  .uretim-step-btn { font-size:0.98rem; padding:.28rem 0.87rem;}
  .uretim-step-ok svg { width:22px; height:10px; }
}

/* -- <600px: TÃ¼m sÃ¼reÃ§ adÄ±mlarÄ± ve menÃ¼ler dikeyleÅŸiyor, paddings/kÃ¼Ã§Ã¼lÃ¼yor -- */
@media (max-width:600px){
  .city-silhouette {
    position: fixed;
    left: 0; right: 0; bottom: 0;
    width: 100vw;
    height: 14vh;
    min-height: 70px;
    max-height: 150px;
  }
  .container-navbar { flex-wrap: wrap; justify-content: flex-end; }
  #projectName {
    flex: 0 0 70%;
    font-size: 17px !important; max-width: 65%; min-width: 0; margin-right: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left;
  }
  #buttonHome { flex: 0 0 30px; padding: 0; margin-left: 0; display: flex; align-items: center;}
  .img-fluid { height: 28px; width: 28px; margin-right: 0; margin-left: 0; }
  .custom-btn { font-size: 12px; padding: 5px 10px; border-radius: 6px; color: #fff; border: none; margin-right: 12px; font-weight: 500; }
  .navbar-toggler { background-color: #c2c5c9; flex: 0 0 auto; margin-left: auto; justify-content: flex-end;}
  .container-fluid { flex-wrap: wrap; }
  .custom-short-menu {
    gap: 12px; width: 90%!important; margin-top: 12px; margin-left:auto; margin-right:auto;
  }
  .menu-btn { flex: 1 1 0; min-width: 0; }
  .menu-btn img { width: 25px; height: 25px; margin-bottom: 4px;}
  .menu-btn span { font-size: 0.8rem; white-space: nowrap; text-align: center;}
  .flow-steps-container { flex-direction: column; gap: .1em; }
  .flow-step-arrow { transform: rotate(90deg); height: 24px; }
  .flow-step-arrow svg { width: 22px; height: 20px; }
  .flow-step-btn { 
    width: 30%; 
    justify-content: center;
    font-size: 1em;                 /* Metin biraz kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
    padding: 0.4em 0.9em;          /* YastÄ±klar azaltÄ±ldÄ± */
    border-radius: 1.4em;           /* KÃ¶ÅŸeler biraz daraldÄ± */
    box-sizing: border-box;         /* Padding geniÅŸliÄŸe dahil edilir */
    margin: 7px 0;
    }
    .er-kutular {
      width: 75%;
    }
  .surec-title { font-size: 1.5em; margin-bottom: 10px; }
  #tab-uretim .bolum-baslik { font-size:1.29rem; padding:.9em .33em .7em .33em; }
  .uretim-tabs-row{ gap:7px;}
  .uretim-tab-btn{ font-size:1.01rem; padding:.6em 1em .66em 1.4em; border-radius:13px; min-width:94px;}
  .uretim-tab-btn .uretim-ikon {font-size:1em;}
  .uretim-step-btn {
    font-size: 0.98rem;           /* YazÄ± bir miktar kÃ¼Ã§Ã¼ldÃ¼ */
    padding: 0.48rem 1.1rem;      /* Daha dar padding */
    border-radius: 13px;          /* Biraz daha az yuvarlaklÄ±k */
    box-shadow: 0 2px 8px 0 rgba(120,140,190,0.10);
    width: 60%;                  /* Tam satÄ±r geniÅŸliÄŸi (opsiyonel) */
    margin: 7px 0;                /* Dikey aralÄ±k korundu */
  }
  .evrak-ekle-btn { font-size: 0.9rem; padding: 0.6rem 1.4rem;}
  .alt-baslik-kutu{font-size:0.95rem; padding:.75rem 1.1rem;}

  #geriRadyalBtn {
    float: right !important;  /* BÃ¼yÃ¼k ekranda saÄŸa geÃ§ebilir */
    display: inline-block;
    margin-left: auto;
    margin-bottom: 10px !important;
  }
  #modalContentGenel > .row > .col-lg-7,
  #modalContentGenel > .row > .col-lg-5 {
    padding-left: 0 !important;
    padding-right: 0 !important;
    align-items: center;
  }
  #modalContentGenel .card {
    width: 90vw;
  }

  .card, .alert, .form-control { font-size: 1rem; }
  #modalContentGenel { padding: 1rem 0.5rem; }
  button, input, select { font-size: 1.04rem; }
  .buton-sil-altpara {
    font-size: 0.75rem !important;
    padding: 0.3rem 0.7rem !important;
    border-radius: 0.55em !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 4px !important;
    min-width: 30px !important;
    min-height: 20px !important;
    height: auto !important;
    box-sizing: border-box !important;
  }
  .buton-sil-altpara i {
    font-size: 0.8em !important;
    margin-right: 3px !important;
    vertical-align: middle !important;
    line-height: normal !important;
  }
}

/* --- Ekstra - ScrollbarlarÄ±nÄ± yumuÅŸatmak isteyenler iÃ§in (isteÄŸe baÄŸlÄ±) --- */
.er-kutular, .file-list { scrollbar-width: thin; scrollbar-color: #bfcfe5 #fafafa;}
.er-kutular::-webkit-scrollbar, .file-list::-webkit-scrollbar { width:7px; background:#fafafa;}
.er-kutular::-webkit-scrollbar-thumb, .file-list::-webkit-scrollbar-thumb { background: #bfcfe5; border-radius: 6px;}
</style>
</head>  
<body class="relative min-h-screen w-full bg-gradient-to-b from-white to-blue-100 flex flex-col items-center justify-start">
  <!-- Alt Åehir SilÃ¼eti SVG -->
  <svg class="city-silhouette" viewBox="0 0 400 96" fill="none" preserveAspectRatio="none" width="100%" height="100%">
  <g>
    <!-- Sol bloklar -->
    <rect x="0" y="60" width="14" height="36" rx="2" fill="#6366f1" opacity="0.13"/>
    <rect x="16" y="40" width="22" height="56" rx="4" fill="#60a5fa" opacity="0.18"/>
    <!-- Ã‡atÄ±lÄ± bina -->
    <rect x="41" y="72" width="12" height="24" rx="2" fill="#818cf8" opacity="0.16"/>
    <polygon points="41,72 47,62 53,72" fill="#818cf8" opacity="0.28"/>
    <rect x="56" y="60" width="16" height="36" rx="3" fill="#38bdf8" opacity="0.14"/>
    <!-- Pencereli uzun blok -->
    <rect x="75" y="36" width="12" height="60" rx="2" fill="#60a5fa" opacity="0.15"/>
    <rect x="81" y="44" width="2" height="8" rx="1" fill="#fff" opacity="0.22"/>
    <rect x="81" y="60" width="2" height="8" rx="1" fill="#fff" opacity="0.15"/>
    <!-- Mini blok -->
    <rect x="90" y="80" width="7" height="16" rx="1.5" fill="#818cf8" opacity="0.19"/>
    
    <!-- Orta bloklar -->
    <rect x="100" y="66" width="18" height="30" rx="2" fill="#6366f1" opacity="0.09"/>
    <rect x="121" y="46" width="28" height="50" rx="3" fill="#818cf8" opacity="0.09"/>
    <rect x="152" y="78" width="12" height="18" rx="2" fill="#60a5fa" opacity="0.16"/>
    <!-- Yan yana iki blok farklÄ± yÃ¼kseklikte -->
    <rect x="170" y="69" width="16" height="27" rx="2" fill="#818cf8" opacity="0.12"/>
    <rect x="188" y="79" width="10" height="17" rx="2" fill="#6366f1" opacity="0.12"/>
    <!-- Asimetrik bÃ¼yÃ¼k blok -->
    <rect x="201" y="29" width="29" height="67" rx="4" fill="#60a5fa" opacity="0.14"/>
    <!-- FarklÄ± ton kÄ±sa blok -->
    <rect x="233" y="74" width="12" height="22" rx="2" fill="#38bdf8" opacity="0.13"/>
    <!-- Ä°nce yÃ¼ksek blok -->
    <rect x="248" y="25" width="9" height="71" rx="2" fill="#818cf8" opacity="0.17"/>
    <!-- DiÄŸer bloklar (dÃ¼z, alÃ§ak/kalÄ±n) -->
    <rect x="260" y="79" width="23" height="17" rx="3" fill="#6366f1" opacity="0.1"/>
    <rect x="287" y="67" width="16" height="29" rx="2" fill="#60a5fa" opacity="0.11"/>
    <!-- Minik bloklar ve farklÄ± renk -->
    <rect x="306" y="82" width="6" height="14" rx="1" fill="#818cf8" opacity="0.17"/>
    <rect x="316" y="68" width="10" height="28" rx="2" fill="#38bdf8" opacity="0.14"/>
    <!-- GeniÅŸ kÄ±sa bina -->
    <rect x="330" y="80" width="26" height="16" rx="2" fill="#6366f1" opacity="0.09"/>
    <!-- SaÄŸda kÃ¼Ã§Ã¼k Ã§atÄ±lÄ± blok -->
    <rect x="360" y="70" width="13" height="26" rx="2" fill="#60a5fa" opacity="0.12"/>
    <polygon points="360,70 366.5,61 373,70" fill="#60a5fa" opacity="0.22"/>
    <!-- SaÄŸda yÃ¼ksek son blok -->
    <rect x="378" y="24" width="18" height="72" rx="2.5" fill="#6366f1" opacity="0.11"/>
    <!-- En saÄŸ mini pencere detayÄ± -->
    <rect x="384" y="32" width="2.5" height="8" rx="1" fill="#fff" opacity="0.20"/>
  </g>
</svg>

    <!-- Responsive Header -->  
    <nav class="header d-flex justify-content-between align-items-center px-3">
        <span class="d-flex align-items-center gap-2">
            <img src="img/icon.png" alt="Logo" width="32" height="32">
            YapÄ±o
        </span>
        <button class="btn custom-btn" id="loginButton" style="display: none;">PROJELER</button>  
    </nav>

    <!-- Navbar -->  
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top shadow-sm mt-4 container-navbar">  
        <div class="container-fluid">  
            <!-- Proje AdÄ± -->  
            <h4 class="navbar-brand" id="projectName">Proje AdÄ±</h4>  
            <!-- Ana Sayfa Butonu -->  
            <button class="btn d-flex navbar-home-button" id="buttonHome">  
                <img src="img/home1_1.png" alt="Katlar GÃ¶rseli" class="img-fluid rounded">  
            </button>
        </div>  
    </nav> 

    <div class="custom-short-menu" id="regulation-button-area">
        <a class="menu-btn" id="approved-button" href="#">
            <img src="img/approved.png" alt="">
            <span>Ruhsat-<br>Ä°skan</span>
        </a>
        <a class="menu-btn" id="graphs-button" href="#">
            <img src="img/growth_1.png" alt="">
            <span>Analizler</span>
        </a>
        <a class="menu-btn" id="sold-button" href="#">
            <img src="/img/property.png" alt="">
            <span>SatÄ±ÅŸ</span>
        </a>
        <a class="menu-btn" id="material-button" href="#">
            <img src="/img/list.png" alt="">
            <span>Malzeme<br>YÃ¶netimi</span>
        </a>
    </div>

    <div id="loader" style="display:none;">
        <div class="spinner"></div>
        <span>YÃ¼kleniyor...</span>
    </div>

    <div class="container pt-3 pb-4">  
      <div class="surec-title">YapÄ± Ãœretim SÃ¼reci</div>  
        <div class="flow-steps-container">
          <button class="flow-step-btn active mb-2" data-tab="arsa">Arsa</button>
          <button class="flow-step-btn mb-2" data-tab="evrak">Evrak Ä°ÅŸleri</button>
          <!--<button class="flow-step-btn mb-2" data-tab="ruhsat">YapÄ± RuhsatÄ±</button>-->
          <button class="flow-step-btn mb-2" data-tab="uretim">Ãœretim</button>
          <button class="flow-step-btn mb-2" data-tab="iscilikler">Ä°ÅŸÃ§ilikler</button>
        </div>
      </div>

      <div class="surec-section mb-4 active" id="tab-arsa">
        <div class="er-kutular"> 
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
              <span class="alt-baslik-ikon" id="arsaBedeliArsa">ğŸ’°</span>  
              Arsa AlÄ±mÄ±
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
              <span class="alt-baslik-ikon" id="yerSahibiÄ°leAnlasmaArsa">ğŸ¤</span>  
              Yer Sahibi Ä°le AnlaÅŸma
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
              <span class="alt-baslik-ikon" id="yerdenCikartmakArsa">â¬†ï¸</span>  
              Yerden Ã‡Ä±kartmak
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
              <span class="alt-baslik-ikon" id="kiraBedeliArsa">ğŸ’µ</span>  
              Kira Bedeli
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
              <span class="alt-baslik-ikon" id="kadastroTutar">ğŸ“</span>  
              Kadastro
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
              <span class="alt-baslik-ikon" id="arsaDigerArsa">â•</span>  
              Arsa DiÄŸer
          </div>
        </div>
      </div>

      <!-- Ä°ÅŸÃ§ilikler Sekmesi Ä°Ã§in -->
      <div class="surec-section mb-4" id="tab-iscilikler">
        <div class="er-kutular">
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="santiyeSefiIsciligi">ğŸ‘·</span>
            Åantiye Åefi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="kalipIsciligi">ğŸªœ</span>
            KalÄ±p Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="demirIsciligi">ğŸ”©</span>
            Demir Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="duvarOrmeIsciligi">ğŸ§±</span>
            Duvar Ã–rme Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="sivaIsciligi">ğŸ—¿</span>
            SÄ±va Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="sapIsciligi">ğŸª£</span>
            Åap Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="catiIsciligi">ğŸ </span>
            Ã‡atÄ± Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="mantolamaIsciligi">ğŸ”¥</span>
            Mantolama Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="yalitimIsciligi">ğŸ§¤</span>
            YalÄ±tÄ±m Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="suTesisatiIsciligi">ğŸš¿</span>
            Su TesisatÄ± Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="elektrikIsciligi">ğŸ’¡</span>
            Elektrik Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="dogalgazIsciligi">ğŸ”¥</span>
            DoÄŸalgaz Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="asansorIsciligi">ğŸ›—</span>
            AsansÃ¶r Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="dekorAlcipanIsciligi">ğŸ–Œï¸</span>
            Dekor AlÃ§Ä±pan Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="perforjeIsciligi">ğŸ› ï¸</span>
            Perforje Ä°ÅŸÃ§iliÄŸi
          </div>
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">
            <span data-kurum="Ä°ÅŸÃ§ilik" class="alt-baslik-ikon" id="digerIsciligi">â•</span>
            Ä°ÅŸÃ§ilik DiÄŸer
          </div>
        </div>
      </div>

      <div class="surec-section mb-4" id="tab-evrak">  
        <div class="er-kutular">  
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
            <span class="alt-baslik-ikon">ğŸ›ï¸</span>  
            Belediye  
            <span class="alt-kutu-arrow">&#9654;</span>  
          </div>  
          <div class="alt-kutu-icerik">  
            <ul>  
              <li data-kurum="Belediye" data-detay="Aplikasyon" id="aplikasyon">Aplikasyon</li>  
              <li data-kurum="Belediye" data-detay="Ä°mar Durumu" id="imarDurumuKaydi">Ä°mar Durumu</li>  
              <li data-kurum="Belediye" data-detay="Kanal Kotu" id="kanalKotu">Kanal Kotu</li>  
              <li data-kurum="Belediye" data-detay="Ruhsat harcÄ±" id="ruhsatHarci">Ruhsat HarcÄ±</li>  
              <li data-kurum="Belediye" data-detay="Zemin etÃ¼dÃ¼ harcÄ±" id="zeminEtuduHarci">Zemin EtÃ¼dÃ¼ HarcÄ±</li>
              <li data-kurum="Belediye" data-detay="Ä°skan harcÄ±" id="iskanHarci">Ä°skan HarcÄ±</li>
              <li data-kurum="Belediye" data-detay="Kanalizasyon ve AtÄ±k Su" id="kanalizasyonVeAtikSu">Kanalizasyon ve AtÄ±k Su</li>
              <li data-kurum="Belediye" data-detay="Åantiye Abonman Su BaÄŸlama" id="santiyeAbonmanSuBaglama">Åantiye Abonman Su BaÄŸlama</li>
              <li data-kurum="Belediye" data-detay="Su TÃ¼ketimi" id="suTukutemi">Su TÃ¼ketimi</li>
              <li data-kurum="Belediye" data-detay="Kontroller ve Ä°zinler" id="kontrollerVeÄ°zinler">Kontroller ve Ä°zinler</li>
              <li data-kurum="Belediye" data-detay="Otopark" id="otoparkBelediye">Otopark</li>
              <li data-kurum="Belediye" data-detay="DiÄŸer" id="digerBelediye">DiÄŸer</li>
            </ul>  
          </div> 

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
            <span class="alt-baslik-ikon">ğŸ–‹ï¸</span>  
            Noter  
            <span class="alt-kutu-arrow">&#9654;</span>  
          </div>  
          <div class="alt-kutu-icerik">  
            <ul>  
              <li data-kurum="Noter" data-detay="MÃ¼teahhitlik SÃ¶zleÅŸmesi" id="muteahhitlikSozlesmesi">MÃ¼teahhitlik SÃ¶zleÅŸmesi</li>  
              <li data-kurum="Noter" data-detay="Vekalet SÃ¶zleÅŸmesi" id="vekaletSozlesmesi">Vekalet SÃ¶zleÅŸmesi</li>  
            </ul>  
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
            <span class="alt-baslik-ikon">ğŸ—ï¸</span>  
            YapÄ± Denetim
            <span class="alt-kutu-arrow">&#9654;</span>  
          </div>  
          <div class="alt-kutu-icerik">  
            <ul>  
              <li data-kurum="YapÄ± Denetim" data-detay="YapÄ± denetim harcÄ±" id="yapiDenetimHarci">YapÄ± Denetim HarcÄ±</li>  
              <li data-kurum="YapÄ± Denetim" data-detay="Fenni Jeoloji" id="fenniJeoloji">Fenni Jeoloji</li>  
              <li data-kurum="YapÄ± Denetim" data-detay="Fenni HaritacÄ±" id="fenniHaritaci">Fenni HaritacÄ±</li>
              <li data-kurum="YapÄ± Denetim" data-detay="Ã‡ip AlÄ±mÄ±" id="cipAlimi">Ã‡ip AlÄ±mÄ±</li>
              <li data-kurum="YapÄ± Denetim" data-detay="Beton Analizi" id="betonAnalizi">Beton Analizi</li>
              <li data-kurum="YapÄ± Denetim" data-detay="DiÄŸer" id="digerYapiDenetim">DiÄŸer</li>
            </ul>  
          </div>
          <!--<div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="kadastroTutar">  
            <span class="alt-baslik-ikon">ğŸ“</span>  
            Kadastro 
          </div> -->
          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
            <span class="alt-baslik-ikon">ğŸŒ</span>  
            Zemin EtÃ¼dÃ¼
            <span class="alt-kutu-arrow">&#9654;</span>  
          </div>  
          <div class="alt-kutu-icerik">  
            <ul>  
              <li data-kurum="Zemin EtÃ¼dÃ¼" data-detay="Zemin EtÃ¼dÃ¼ Raporu" id="zeminEtuduRaporu">Zemin EtÃ¼dÃ¼ Raporu</li>  
              <li data-kurum="Zemin EtÃ¼dÃ¼" data-detay="Zemin Ä°yileÅŸtirme" id="zeminIyilestirme">Zemin Ä°yileÅŸtirme</li>  
              <li data-kurum="Zemin EtÃ¼dÃ¼" data-detay="DiÄŸer" id="digerZeminEtudu">DiÄŸer</li>  
            </ul>  
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
            <span class="alt-baslik-ikon">ğŸ“</span>  
            Projeler
            <span class="alt-kutu-arrow">&#9654;</span>  
          </div>  
          <div class="alt-kutu-icerik">  
            <ul>  
              <li data-kurum="Projeler" data-detay="Mimari Proje" id="mimariProje">Mimari Proje</li>  
              <li data-kurum="Projeler" data-detay="Statik Proje" id="statikProje">Statik Proje</li>
              <li data-kurum="Projeler" data-detay="Elektrik Projesi" id="elektrikProje">Elektrik Projesi</li>
              <li data-kurum="Projeler" data-detay="Tesisat Projesi" id="tesisatProje">Tesisat Projesi</li>
              
              <li data-kurum="Projeler" data-detay="HUS" id="hesProje">HUS</li>  
              <li data-kurum="Projeler" data-detay="Akustik Proje" id="akustikProje">Akustik</li>
              <li data-kurum="Projeler" data-detay="AsansÃ¶r Projesi" id="asansorProjesi">AsansÃ¶r Projesi</li>
              <li data-kurum="Projeler" data-detay="DiÄŸer" id="digerProjeler">DiÄŸer</li> 
            </ul>  
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="haritaci">  
            <span class="alt-baslik-ikon">ğŸ“</span>  
            HaritacÄ± 
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
            <span class="alt-baslik-ikon">âš¡</span>  
            Åantiye Elektrik
            <span class="alt-kutu-arrow">&#9654;</span>  
          </div>
          <div class="alt-kutu-icerik">  
            <ul>  
              <li data-kurum="Åantiye Elektrik" data-detay="Åantiye Elektrik BaÄŸlama" id="santiyeElektrikBaglama">Åantiye Elektrik BaÄŸlama</li>  
              <li data-kurum="Åantiye Elektrik" data-detay="Åantiye Elektrik TÃ¼ketim" id="santiyeElektrikTuketim">Åantiye Elektrik TÃ¼ketim</li>
              <li data-kurum="Åantiye Elektrik" data-detay="DiÄŸer" id="santiyeElektrikDiger">DiÄŸer</li> 
            </ul>  
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="isGuvenligi">  
            <span class="alt-baslik-ikon">ğŸ›¡ï¸</span>  
            Ä°ÅŸ GÃ¼venliÄŸi 
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="ssk">  
            <span class="alt-baslik-ikon">ğŸ©º</span>  
            SSK 
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="kentselDonusum">  
            <span class="alt-baslik-ikon">ğŸ˜ï¸</span>  
            Kentsel DÃ¶nÃ¼ÅŸÃ¼m 
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false">  
            <span class="alt-baslik-ikon">ğŸ“œ</span>  
            Tapu MÃ¼dÃ¼rlÃ¼ÄŸÃ¼
            <span class="alt-kutu-arrow">&#9654;</span>  
          </div>
          <div class="alt-kutu-icerik">  
            <ul>  
              <li data-kurum="Tapu MÃ¼dÃ¼rlÃ¼ÄŸÃ¼" data-detay="AlÄ±m-SatÄ±m Ãœcreti" id="tapuAlimSatim">AlÄ±m-SatÄ±m Ãœcreti</li>  
              <li data-kurum="Tapu MÃ¼dÃ¼rlÃ¼ÄŸÃ¼" data-detay="Kat Ä°rtifa Kurma" id="tapuKatÄ°rtifa">Kat Ä°rtifa Kurma</li>
            </ul>  
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="emlakci">  
            <span class="alt-baslik-ikon">ğŸ‘”</span>  
            EmlakÃ§Ä± 
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="reklam">  
            <span class="alt-baslik-ikon">ğŸ“º</span>  
            Reklam ve TanÄ±tÄ±m 
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="avukat">  
            <span class="alt-baslik-ikon">âš–ï¸</span>  
            Avukat
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="vergiler">  
            <span class="alt-baslik-ikon">ğŸ§¾</span>  
            Vergiler 
          </div>

          <div class="alt-baslik-kutu" tabindex="0" aria-expanded="false" id="ozelHizmetler">  
            <span class="alt-baslik-ikon">ğŸŒŸ</span>  
            Ã–zel Hizmetler 
          </div>
          </div>
          </div>

      <div class="surec-section" id="tab-ruhsat">  
        <button class="evrak-ekle-btn" id="btnYapiRuhsati">Evrak Ekle</button>  
      </div>

      <div class="surec-section mb-4" id="tab-uretim">
        <div class="uretim-tabs-row">
          <button id="btnKaba" class="uretim-tab-btn active"><span class="uretim-ikon">ğŸ§±</span> Kaba Ãœretim</button>
          <button id="btnInce" class="uretim-tab-btn"><span class="uretim-ikon">ğŸ¨</span> Ä°nce Ãœretim</button>
        </div>
        <!-- Kaba Ãœretim AdÄ±mlarÄ± -->
        <div class="uretim-kategori" id="kabaUretim" style="display:block;">
          <div class="uretim-steps-row w-100 mx-auto" style="max-width:980px;"></div>
        </div>
        <!-- Ä°nce Ãœretim AdÄ±mlarÄ± (boÅŸ ÅŸablon) -->
        <div class="uretim-kategori" id="inceUretim" style="display:none;">
          <div class="uretim-steps-row w-100 mx-auto" style="max-width:980px;justify-content:center;">
            <span style="font-family:'Varela Round', Arial,sans-serif;color:#7b8399;font-size:1.13rem;opacity:0.8;">Ä°nce Ã¼retim adÄ±mlarÄ± burada listelenecekâ€¦</span>
        </div>
      </div>

    </div>


    <!-- Dinamik Modal -->
<div class="modal fade" id="modalUretim" tabindex="-1" aria-labelledby="modalUretimLabel" aria-hidden="true">  
  <div class="modal-dialog modal-xl modal-dialog-scrollable">  
    <div class="modal-content" style="border-radius:19px;">  
      <div class="modal-header bg-primary text-white">  
        <h5 class="modal-title" id="modalUretimLabel">  
          <span id="modalBaslikIkon"></span>  
          <span id="modalBaslikText"></span>  
        </h5>  
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>  
      </div>  
      <div class="modal-body pb-1">  
        <div id="modalContentGenel"></div>  
      </div>  
    </div>  
  </div>  
</div>

<div class="modal fade" id="evrakModal" tabindex="-1" aria-labelledby="evrakModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="evrakModalLabel">Evrak GÃ¶rÃ¼ntÃ¼le</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body" id="evrakModalBody" style="min-height:350px;">
        <!-- Ä°Ã§erik buraya yÃ¼klenecek -->
      </div>
    </div>
  </div>
</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <script type="module">
    import { showWarningMessage } from '/js/showMessage.js';

    const projectNameString = document.getElementById("projectName");
    const approvedButton = document.getElementById("approved-button");
    const graphsButton = document.getElementById("graphs-button");
    const soldButton = document.getElementById("sold-button");
    const material = document.getElementById("material-button");
    const buttonHome = document.getElementById("buttonHome");
    const loginButton = document.getElementById("loginButton");
    const imageInput = document.getElementById('modalImageInput');
    const previewArea = document.getElementById('modalPreviewArea');
    const btn = document.getElementById('modalToPdfBtn');
    let imgDataUrl = null;
    const btnKaba = document.getElementById('btnKaba');
    const btnInce = document.getElementById('btnInce');
    const kabaUretim = document.getElementById('kabaUretim');
    const inceUretim = document.getElementById('inceUretim');
    const kadastroTutar = document.getElementById('kadastroTutar');
    const haritaci = document.getElementById('haritaci');
    const vergiler = document.getElementById('vergiler');
    const ssk = document.getElementById('ssk');
    const btnYapiRuhsati = document.getElementById('btnYapiRuhsati');
    const isGuvenligi = document.getElementById('isGuvenligi');
    const emlakci = document.getElementById('emlakci');
    const reklam = document.getElementById('reklam');
    const avukat = document.getElementById('avukat');
    const ozelHizmetler = document.getElementById('ozelHizmetler');

    let userId = null;
    let projectName = null;
    let building = null;
    let floorsDataFromDb = null;
    let aktifKalemId = null;
    let kalemId = null;
    

    // DOM yÃ¼klendiÄŸinde iÅŸlem baÅŸlat  
    document.addEventListener("DOMContentLoaded", () => { 

        window.user = {{#if user}}
        { "email": "{{user.email}}", "role": "{{user.role}}", "userId": "{{user.id}}", "project": {{{json project}}} }
        {{else}}
            { "role": "{{role}}" }
        {{/if}};

        userId = window.user.userId;
        const projectNameDb = window.user.project.projectName;
        projectName = projectNameDb;
        if(projectName){
            const projectNameText = projectNameDb.toUpperCase();
            projectNameString.textContent = projectNameText;
        }
        if(userId){
            loginButton.style.display = "block";
        } else{
            loginButton.style.display = "none";
        }

        const urlParams = new URLSearchParams(window.location.search);  
        const cameFrom = urlParams.get('from');  
        if (cameFrom) {  
            fromControl = true;
            regulationButtonMobileArea.style.display = "none";
            regulationButtonArea.style.display = "none";
        }
 
        // Ä°lk aÃ§Ä±lÄ±ÅŸta Kaba Ãœretim aÃ§Ä±k baÅŸlasÄ±n
        toggleTab(true);

        // Buton tÄ±klama
        btnKaba.addEventListener('click', function() { toggleTab(true); });
        btnInce.addEventListener('click', function() { toggleTab(false); });
    });


    // Sekmeler arasÄ±nda geÃ§iÅŸ (Kaba & Ä°nce Ãœretim)
    function toggleTab(showKaba) {
      if (showKaba) {
        kabaUretim.style.display = 'block';
        inceUretim.style.display = 'none';
        btnKaba.classList.add('active');
        btnInce.classList.remove('active');
      } else {
        kabaUretim.style.display = 'none';
        inceUretim.style.display = 'block';
        btnInce.classList.add('active');
        btnKaba.classList.remove('active');
      }
    }

    // (EÄŸer birden fazla flow sekmesi varsa kullan)
    // Flow tab switch
    document.querySelectorAll('.flow-step-btn').forEach(function(tab){
      tab.addEventListener('click', function(){
          document.querySelectorAll('.flow-step-btn').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          const sectionId = 'tab-' + this.getAttribute('data-tab');
          document.querySelectorAll('.surec-section').forEach(sec => sec.classList.remove('active'));
          document.getElementById(sectionId).classList.add('active');
      });
    });

    // ============ Accordion ==================
document.querySelectorAll('.alt-baslik-kutu').forEach(function(header) {
  header.addEventListener('click', function(){
    let content = header.nextElementSibling;
    // alt-kutu-icerik yoksa accordion iÅŸlemi yapma!
    if (!content || !content.classList.contains('alt-kutu-icerik')) return;

    const isOpen = header.getAttribute('aria-expanded') === 'true';

    // TÃ¼m baÅŸlÄ±k ve iÃ§erikleri kapat
    document.querySelectorAll('.alt-baslik-kutu').forEach(h => {
      h.setAttribute('aria-expanded', 'false');
      // .alt-kutu-arrow varsa yÃ¶nÃ¼nÃ¼ deÄŸiÅŸtir, yoksa hata verme
      let arrow = h.querySelector('.alt-kutu-arrow');
      if (arrow) arrow.innerHTML = "&#9654;";
    });
    document.querySelectorAll('.alt-kutu-icerik').forEach(c => c.style.display = 'none');

    // AÃ§/kapa iÅŸlemi
    if(content && !isOpen){
      header.setAttribute('aria-expanded','true');
      content.style.display = 'block';
      let arrow = header.querySelector('.alt-kutu-arrow');
      if (arrow) arrow.innerHTML = "&#9660;";
    }
  });
  header.addEventListener('keydown', function(e){
    if(e.key === "Enter" || e.key === " ") {
      e.preventDefault(); header.click();
    }
  });
});

// BaÅŸta kapalÄ± baÅŸlat
document.querySelectorAll('.alt-kutu-icerik').forEach(c => c.style.display = 'none');


let aktifEvrakKurum = null, aktifEvrakDetay = null, aktifEvrakKey = null, aktifEvrakId=null;
// ============ Alt Liste <li> Click - Modal ==================
document.querySelectorAll('.alt-kutu-icerik li').forEach(function(item) {
  item.style.cursor = 'pointer';
  item.addEventListener('click', function() {
    aktifAdimId = null; // Kaba Ãœretimden ayÄ±rt!
    aktifAltKalem = null;
    aktifEvrakKurum = this.getAttribute('data-kurum') || '';
    aktifEvrakId = this.getAttribute('id') || '';
    aktifEvrakDetay = this.getAttribute('data-detay') || this.innerText.trim();
    aktifEvrakKey = `evrak:${aktifEvrakKurum}:${aktifEvrakDetay}`;

    document.getElementById('modalBaslikIkon').textContent = ikonBul(aktifEvrakKurum);
    document.getElementById('modalBaslikText').textContent = aktifEvrakKurum + ' - ' + aktifEvrakDetay;

    showOdemeEvrakFormIslem(false, true,null,aktifEvrakKurum,null,aktifEvrakId); // (isRadyal=false, isEvrakIsleri=true)
    bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
  });
});
ozelHizmetler.addEventListener('click', function() {
  aktifEvrakKurum = "Ã–zel Hizmetler";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸŒŸ";
  document.getElementById('modalBaslikText').textContent = "Ã–zel Hizmetler " + ' - ' + " Ã–demeler";
  showOdemeEvrakFormIslem(false, true,null,"Ã–zel Hizmetler",null,"ozelHizmetler"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
avukat.addEventListener('click', function() {
  aktifEvrakKurum = "Avukat";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "âš–ï¸";
  document.getElementById('modalBaslikText').textContent = "Avukat " + ' - ' + " Ã–demeler";
  showOdemeEvrakFormIslem(false, true,null,"Avukat",null,"avukat"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
reklam.addEventListener('click', function() {
  aktifEvrakKurum = "Reklam ve TanÄ±tÄ±m";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ“º";
  document.getElementById('modalBaslikText').textContent = "Reklam ve TanÄ±tÄ±m " + ' - ' + " Ã–demeler";
  showOdemeEvrakFormIslem(false, true,null,"Reklam ve TanÄ±tÄ±m",null,"reklam"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
emlakci.addEventListener('click', function() {
  aktifEvrakKurum = "EmlakÃ§Ä±";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ‘”";
  document.getElementById('modalBaslikText').textContent = "EmlakÃ§Ä± " + ' - ' + " Ã–demeler";
  showOdemeEvrakFormIslem(false, true,null,"EmlakÃ§Ä±",null,"emlakci"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
kentselDonusum.addEventListener('click', function() {
  aktifEvrakKurum = "Kentsel DÃ¶nÃ¼ÅŸÃ¼m";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ˜ï¸";
  document.getElementById('modalBaslikText').textContent = "Kentsel DÃ¶nÃ¼ÅŸÃ¼m " + ' - ' + " Ã–demeler";
  showKenselDonusumModal(false, true,null,aktifEvrakKurum,null,"kentselDonusum");
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
isGuvenligi.addEventListener('click', function() {
  aktifEvrakKurum = "Ä°ÅŸ GÃ¼venliÄŸi";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ›¡ï¸";
  document.getElementById('modalBaslikText').textContent = "Ä°ÅŸ GÃ¼venliÄŸi " + ' - ' + " Ã–demeler";
  showOdemeEvrakFormIslem(false, true,null,"Ä°ÅŸ GÃ¼venliÄŸi",null,"isGuvenligi"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
haritaci.addEventListener('click', function() {
  aktifEvrakKurum = "HaritacÄ±";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ“";
  document.getElementById('modalBaslikText').textContent = "HaritacÄ± " + ' - ' + "HaritacÄ± Ã–demeleri";
  showOdemeEvrakFormIslem(false, true,null,"HaritacÄ±",null,"haritaciTutar"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
vergiler.addEventListener('click', function() {
  aktifEvrakKurum = "Vergiler";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ§¾";
  document.getElementById('modalBaslikText').textContent = "Vergiler " + ' - ' + "Vergi Ã–demeleri";
  showOdemeEvrakFormIslem(false, true,null,"Vergi",null,"vergiTutar"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});
ssk.addEventListener('click', function() {
  aktifEvrakKurum = "SSK";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ©º";
  document.getElementById('modalBaslikText').textContent = "SSK " + ' - ' + "SSK Ã–demeleri";
  showOdemeEvrakFormIslem(false, true,null,"SSK",null,"sskTutar"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});

// Sadece alt-kutu-icerik gelmeyen alt-baslik-kutu'lar = Arsa baÅŸlÄ±klarÄ± olarak tanÄ±mlanÄ±r!
document.querySelectorAll('#tab-arsa .alt-baslik-kutu').forEach(function(header){
  header.addEventListener('click', function(){
    // Ä°konun id'sine eriÅŸ
    const ikonSpan = header.querySelector('.alt-baslik-ikon');
    if (!ikonSpan || !ikonSpan.id) return; // GÃ¼venlik Ã¶nlemi

    const ikonId = ikonSpan.id;
    const ikon = ikonSpan.textContent.trim();
    const baslik = header.textContent.trim();
    aktifEvrakKurum="Arsa";

    // Ä°d'ye gÃ¶re iÅŸlem yap
    switch(ikonId) {
      case "arsaBedeliArsa":
        aktifEvrakDetay = "Arsa Bedeli";
        document.getElementById('modalBaslikIkon').textContent = 'ğŸ’°';
        document.getElementById('modalBaslikText').textContent = "Arsa " + ' - ' + "Arsa Bedeli";
        showOdemeEvrakFormIslem(false, true,null,aktifEvrakKurum,null,ikonId);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
        break;
      case "yerSahibiÄ°leAnlasmaArsa":
        aktifEvrakDetay = "Yer Sahibi Ä°le AnlaÅŸma";
        document.getElementById('modalBaslikIkon').textContent = 'ğŸ¤';
        document.getElementById('modalBaslikText').textContent = "Yer Sahibi Ä°le AnlaÅŸma ";
        showYerSahibiAnlasmaModal(false, true,null,aktifEvrakKurum,null,ikonId);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
        break;
      case "yerdenCikartmakArsa":
        aktifEvrakDetay = "Yerden Ã‡Ä±kartmak";
        document.getElementById('modalBaslikIkon').textContent = 'â¬†ï¸';
        document.getElementById('modalBaslikText').textContent = "Yerden Ã‡Ä±kartmak" + ' - ' + "Yerden Ã‡Ä±kartma Bedeli";
        showOdemeEvrakFormIslem(false, true,null,aktifEvrakKurum,null,ikonId);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
        break;
      case "kiraBedeliArsa":
        aktifEvrakDetay = "Kira Bedeli";
        document.getElementById('modalBaslikIkon').textContent = 'ğŸ’µ';
        document.getElementById('modalBaslikText').textContent = "Kira Bedeli";
        showOdemeEvrakFormIslem(false, true,null,aktifEvrakKurum,null,ikonId);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
        break;
      case "kadastroTutar":
        aktifEvrakDetay = "Kadastro Ã–demesi";
        document.getElementById('modalBaslikIkon').textContent = 'ğŸ“';
        document.getElementById('modalBaslikText').textContent = "Kadastro Ã–demesi";
        showOdemeEvrakFormIslem(false, true,null,"Kadastro",null,"kadastroTutar");
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
        break;
      case "arsaDigerArsa":
        aktifEvrakDetay = "Arsa DiÄŸer";
        document.getElementById('modalBaslikIkon').textContent = 'â•';
        document.getElementById('modalBaslikText').textContent = "Arsa DiÄŸer" + ' - ' + "Arsa DiÄŸer Ã–demeler";
        showOdemeEvrakFormIslem(false, true,null,aktifEvrakKurum,null,ikonId);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
        break;
      default:
        alert('Bilinmeyen baÅŸlÄ±k!');
    }
  });

  header.addEventListener('keydown', function(e){
    if(e.key === "Enter" || e.key === " ") {
      e.preventDefault(); header.click();
    }
  });
});

function ikonBul(kurum) {
  switch (kurum) {
    case 'Belediye': return 'ğŸ›ï¸';
    case 'Noter': return 'ğŸ–‹ï¸';
    case 'YapÄ± Denetim': return 'ğŸ—ï¸';
    case 'Kadastro' : return 'ğŸ“';
    case 'Zemin EtÃ¼dÃ¼': return 'ğŸŒ';
    case 'Projeler': return 'ğŸ“';
    case 'HaritacÄ±':return 'ğŸ“';
    case 'Åantiye Elektrik':return 'âš¡';
    case 'Tapu MÃ¼dÃ¼rlÃ¼ÄŸÃ¼':return 'ğŸ“œ';
    case 'Ä°ÅŸ GÃ¼venliÄŸi' : return 'ğŸ›¡ï¸';
    case 'SSK': return '';
    case 'Kentsel DÃ¶nÃ¼ÅŸÃ¼m': return 'ğŸ˜ï¸';
    case 'EmlakÃ§Ä±' : return 'ğŸ‘”';
    case 'Reklam ve TanÄ±tÄ±m': return 'ğŸ“º';
    case 'Avukat' :return 'âš–ï¸';
    case 'Vergiler':return 'ğŸ§¾';
    case 'Ã–zel Hizmetler' : return 'ğŸŒŸ';
    case 'DiÄŸer': return 'ğŸ—ƒï¸';
    default: return '';
  }
}

// YapÄ± RuhsatÄ±
btnYapiRuhsati.addEventListener('click', function() {
  aktifEvrakKurum = "YapÄ± RuhsatÄ±";
  aktifEvrakDetay = "";
  document.getElementById('modalBaslikIkon').textContent = "ğŸ“„â•";
  document.getElementById('modalBaslikText').textContent = "YapÄ± RuhsatÄ± " + ' - ' + "Ã–demeler";
  showOdemeEvrakFormIslem(false, true,null,"YapiRuhsati",null,"yapiRuhsati"); // (isRadyal=false, isEvrakIsleri=true)
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
});


// Ä°ÅŸÃ§ilik alt baÅŸlÄ±klarÄ± iÃ§in accordion
document.querySelectorAll('#tab-iscilikler .alt-baslik-kutu').forEach(function(header) {
  header.addEventListener('click', function() {
    const kurum = this.querySelector('.alt-baslik-ikon').getAttribute('data-kurum'); // data-kurum bilgisini al

    // TÄ±klanan baÅŸlÄ±k iÃ§in bilgileri ayarlama iÅŸlemi
    aktifEvrakKurum = kurum;
    aktifEvrakDetay = this.innerText.trim();
    const aktifEvrakId = this.querySelector('.alt-baslik-ikon').getAttribute('id') || '';

    //console.log("aktifEvrakKurum:", aktifEvrakKurum);
    //console.log("aktifEvrakDetay:", aktifEvrakDetay);

    // Modal baÅŸlÄ±ÄŸÄ±nÄ± ayarla
    document.getElementById('modalBaslikIkon').textContent = ikonBul(aktifEvrakKurum);
    document.getElementById('modalBaslikText').textContent = `${aktifEvrakKurum} - ${aktifEvrakDetay}`;

    // ModalÄ± gÃ¶ster
    showOdemeEvrakFormIslem(false, true, null, aktifEvrakKurum, null, aktifEvrakId); // (isRadyal=false, isEvrakIsleri=true)
    bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
    
  });
  
  header.addEventListener('keydown', function(e) {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault(); header.click();
    }
  });
});

// BaÅŸta kapalÄ± baÅŸlat
document.querySelectorAll('#tab-iscilikler .alt-kutu-icerik').forEach(c => c.style.display = 'none');

    // Kaba Ãœretim AdÄ±mlarÄ± - TAM LÄ°STE
const URETIM_ADIMLARI = [
  { id: 'santiyeKurma',  ad: "Åantiye kurma",                     icon: "fa-hard-hat"         },
  { id: 'temelKazma',    ad: "Temel kazma",                       icon: "fa-mountain-sun"     },
  { id: 'groBeton',      ad: "Gro beton",                         icon: "fa-bricks"           },
  { id: 'radyalTemel',   ad: "Radyal Temel",                      icon: "fa-cube"             },
  { id: 'perdeBetonu',   ad: "Perde betonu",                      icon: "fa-border-all"       },
  { id: 'temelIzolasyon',ad: "Temel izolasyonu",                  icon: "fa-shield-halved"    },
  { id: 'dolgu',         ad: "Dolgu",                             icon: "fa-road"             },
  { id: 'subasman',      ad: "Subasman",                          icon: "fa-square-poll-horizontal"},
  { id: 'zeminBetonu',   ad: "Zemin betonu",                      icon: "fa-th-large"         },
  { id: 'katBetonlari',  ad: "1-2-3-4. kat betonlarÄ±",            icon: "fa-layer-group"      },
  { id: 'kapamaBetonu', ad: "Kapama betonu",                      icon: "fa-layer-minus"      },
  { id: 'catiUygulama',  ad: "Ã‡atÄ± uygulamalarÄ±",                 icon: "fa-house-chimney"    },
  { id: 'duvarOrme',     ad: "Duvar Ã¶rme",                        icon: "fa-grip-lines-vertical"},
  { id: 'sap',            ad: "ÅAP",                              icon: "fa-fill"    }
];

const SANTIYE_KURMA = [
  { id:"citleme",         ad:"Ã‡evre Ã‡iti",                 icon:"fa-border-style",         birimler:["metre", "adet"] },
  { id:"nizamiye",        ad:"GÃ¼venlik/Nizamiye",          icon:"fa-shield-alt",           birimler:["adet"] },
  { id:"konteyner_ofis",  ad:"Ofis Konteyneri",            icon:"fa-home",                 birimler:["adet", "mÂ²"] },
  { id:"konteyner_yemek", ad:"Yemekhane Konteyneri",       icon:"fa-utensils",             birimler:["adet", "mÂ²"] },
  { id:"konteyner_wc",    ad:"WC/DuÅŸ Konteyneri",          icon:"fa-restroom",             birimler:["adet"] },
  { id:"elektrik",        ad:"Elektrik AltyapÄ±sÄ±",         icon:"fa-bolt",                 birimler:["metre", "adet"] },
  { id:"su",              ad:"Su BaÄŸlantÄ±sÄ±",              icon:"fa-tint",                 birimler:["metre", "adet"] },
  { id:"zemin_betonu",    ad:"Zemin Beton/Tabliye",        icon:"fa-th-large",             birimler:["mÂ²", "mÂ³"] },
  { id:"depo",            ad:"Malzeme Deposu",             icon:"fa-box",                  birimler:["adet", "mÂ²"] },
  { id:"jenerator",       ad:"JeneratÃ¶r",                  icon:"fa-charging-station",     birimler:["adet"] },
  { id:"su_deposu",       ad:"Su Deposu",                  icon:"fa-water",                birimler:["adet", "litre", "mÂ³"] },
  { id:"aydinlatma",      ad:"Åantiye AydÄ±nlatmasÄ±",       icon:"fa-lightbulb",            birimler:["adet"] },
  //{ id:"levhalar",        ad:"Tabelalar / Levhalar",       icon:"fa-exclamation-triangle", birimler:["adet"] },
  { id:"camasirhane",     ad:"Ã‡amaÅŸÄ±rhane",                icon:"fa-tshirt",               birimler:["adet"] },
  { id:"guvenlik_kamera", ad:"GÃ¼venlik KamerasÄ±",          icon:"fa-video",                birimler:["adet", "set"] },
  { id:"yangin",          ad:"YangÄ±n EkipmanÄ±",            icon:"fa-fire-extinguisher",    birimler:["adet"] },
  { id:"ilk_yardim",      ad:"Ä°lk YardÄ±m Ãœnitesi",         icon:"fa-briefcase-medical",    birimler:["adet"] },
  { id:"tasinim",         ad:"Personel Servisi/TaÅŸÄ±ma",    icon:"fa-bus",                  birimler:["adet", "gÃ¼n"] },
  { id:"iskele",          ad:"GeÃ§ici Ä°skele",              icon:"fa-ladder-water",         birimler:["metre", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const TEMEL_KAZMA = [
  { id: "kazi_yapimi", ad: "KazÄ± YapÄ±lmasÄ±", icon: "fa-mountain", birimler: ["mÂ³", "mÂ²", "adet"] },
  { id: "makine_kiralama", ad: "KazÄ± Makinesi Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±", icon: "fa-tractor", birimler: ["saat", "gÃ¼n", "mÂ³"] },
  { id: "yukleme", ad: "Malzeme YÃ¼klenmesi", icon: "fa-dumpster", birimler: ["mÂ³", "saat"] },
  { id: "tasima", ad: "Malzeme Nakliyesi", icon: "fa-truck", birimler: ["mÂ³", "km", "ton"] },
  { id: "tesviye", ad: "Tesviye/DÃ¼zeltme", icon: "fa-ruler-horizontal", birimler: ["mÂ²", "mÂ³"] },
  { id: "iksa", ad: "Ä°ksa/Destekleme", icon: "fa-border-style", birimler: ["m", "mÂ²", "adet"] },
  { id: "drenaj", ad: "Drenaj ve Su Tahliyesi", icon: "fa-water", birimler: ["metre", "adet"] },
  { id: "su_indirimi", ad: "Taban Suyu Ä°ndirimi", icon: "fa-tint", birimler: ["saat", "gÃ¼n"] },
  { id: "hafriyat_depolama", ad: "Hafriyat Depolama/UzaklaÅŸtÄ±rma", icon: "fa-dumpster-fire", birimler: ["mÂ³", "kamyon"] },
  { id: "elle_kazi", ad: "Elle KazÄ±", icon: "fa-person-digging", birimler: ["mÂ³", "saat"] },
  { id: "kaba_kazi", ad: "Kaba KazÄ±", icon: "fa-mound", birimler: ["mÂ³"] },
  { id: "ince_kazi", ad: "Ä°nce KazÄ±/Åev DÃ¼zeltmesi", icon: "fa-sliders-h", birimler: ["mÂ³"] },
  { id: "patlatma", ad: "PatlatmalÄ± KazÄ±", icon: "fa-bomb", birimler: ["mÂ³", "adet"] },
  { id: "kontrolluk", ad: "KazÄ± KontrollÃ¼ÄŸÃ¼ ve Ã–lÃ§Ã¼m", icon: "fa-tape", birimler: ["gÃ¼n", "adet"] },
  { id: "zemin_test", ad: "Zemin Testleri", icon: "fa-vial", birimler: ["adet"] },
  { id: "gecici_yol", ad: "GeÃ§ici Yol AÃ§Ä±lmasÄ±", icon: "fa-road", birimler: ["metre"] },
  { id: "guvenlik", ad: "KazÄ± GÃ¼venlik Tedbirleri", icon: "fa-exclamation-triangle", birimler: ["adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const GRO_BETON = [
  { id: "alan_hazirligi", ad: "Alan HazÄ±rlÄ±ÄŸÄ±", icon: "fa-ruler-horizontal", birimler: ["mÂ²", "adet"] },
  { id: "kalip", ad: "KalÄ±p HazÄ±rlÄ±ÄŸÄ±", icon: "fa-border-style", birimler: ["metre", "adet"] },
  { id: "beton_temini", ad: "Beton Temini ve Nakliyesi", icon: "fa-truck", birimler: ["mÂ³", "adet"] },
  { id: "gro_beton_serme", ad: "Beton Serme ve Yayma", icon: "fa-mountain", birimler: ["mÂ³"] },
  { id: "tesviye", ad: "Tesviye / Åap Ã‡ekme", icon: "fa-ruler-horizontal", birimler: ["mÂ²"] },
  { id: "sikistirma", ad: "SÄ±kÄ±ÅŸtÄ±rma / Vibrasyon", icon: "fa-vibrate", birimler: ["mÂ³", "adet"] },
  { id: "bakim", ad: "Sulama ve BakÄ±m", icon: "fa-tint", birimler: ["mÂ³", "gÃ¼n"] },
  { id: "numune", ad: "Numune AlÄ±mÄ± ve Test", icon: "fa-vials", birimler: ["adet"] },
  { id: "temizlik", ad: "AtÄ±k TemizliÄŸi", icon: "fa-broom", birimler: ["mÂ²", "gÃ¼n"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const DOLGU = [
  { id: "malzeme_temini", ad: "Dolgu Malzemesi Temini ve Nakliyesi", icon: "fa-truck", birimler: ["mÂ³", "ton"] },
  { id: "alan_hazirligi", ad: "Dolgu AlanÄ± HazÄ±rlÄ±ÄŸÄ±", icon: "fa-ruler-combined", birimler: ["mÂ²", "mÂ³"] },
  { id: "serme", ad: "Malzeme Serilmesi", icon: "fa-layer-group", birimler: ["mÂ³"] },
  { id: "sikistirma", ad: "SÄ±kÄ±ÅŸtÄ±rma", icon: "fa-vibrate", birimler: ["mÂ³"] },
  { id: "nemlendirme", ad: "Nemlendirme", icon: "fa-tint", birimler: ["mÂ³", "gÃ¼n"] },
  { id: "seviye_kontrol", ad: "Seviye ve Kot KontrolÃ¼", icon: "fa-tape", birimler: ["mÂ²", "gÃ¼n"] },
  { id: "numune", ad: "Numune AlÄ±mÄ± ve Laboratuvar Deneyleri", icon: "fa-vials", birimler: ["adet"] },
  { id: "gecici_yol", ad: "GeÃ§ici Yol/Platform", icon: "fa-road", birimler: ["m", "mÂ²"] },
  { id: "atik_tasima", ad: "AtÄ±k/Fazla Malzeme UzaklaÅŸtÄ±rma", icon: "fa-dumpster", birimler: ["mÂ³", "ton"] },
  { id: "drenaj", ad: "Drenaj BoÅŸluklarÄ±", icon: "fa-water", birimler: ["metre", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet"] }
];

const RADYAL_ALTKALEM = [
  { id:"demir",   ad:"Demir",   icon:"fa-dna",           birimler:["kg", "ton", "adet"] },
  { id:"beton",   ad:"Beton",   icon:"fa-mountain",      birimler:["mÂ³"] },
  { id:"tel",     ad:"Tel",     icon:"fa-wave-square",   birimler:["kg", "m", "rulo"] },
  { id:"civi",    ad:"Ã‡ivi",    icon:"fa-thumbtack",     birimler:["kg", "kutu", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const TEMEL_IZALASYONU = [
  { id:"su_tutucu_bant", ad:"Su Tutucu Bant",    icon:"fa-tape",           birimler:["metre", "rulo", "adet"] },
  { id:"mebran",         ad:"Mebran",            icon:"fa-layer-group",    birimler:["mÂ²", "rulo", "adet"] },
  { id:"likit_mebran",   ad:"Likit Mebran",      icon:"fa-tint",           birimler:["kg", "kova", "litre"] },
  { id:"drenaj_levhasi", ad:"Drenaj LevhasÄ±",    icon:"fa-water",          birimler:["mÂ²", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const SU_BASMAN = [
  { id:"celik_hasir",    ad:"Ã‡elik HasÄ±r",       icon:"fa-border-all",     birimler:["mÂ²", "adet", "rulo"] },            
  { id:"beton",          ad:"Beton",             icon:"fa-mountain",       birimler:["mÂ³"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const ZEMIN_BETONU = [
  { id:"demir",   ad:"Demir",   icon:"fa-dna",           birimler:["kg", "ton", "adet"] },
  { id:"beton",   ad:"Beton",   icon:"fa-mountain",      birimler:["mÂ³"] },
  { id:"tel",     ad:"Tel",     icon:"fa-wave-square",   birimler:["kg", "m", "rulo"] },
  { id:"civi",    ad:"Ã‡ivi",    icon:"fa-thumbtack",     birimler:["kg", "kutu", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const KAT_BETONLARI = [
  { id:"demir",   ad:"Demir",   icon:"fa-dna",           birimler:["kg", "ton", "adet"] },
  { id:"beton",   ad:"Beton",   icon:"fa-mountain",      birimler:["mÂ³"] },
  { id:"tel",     ad:"Tel",     icon:"fa-wave-square",   birimler:["kg", "m", "rulo"] },
  { id:"civi",    ad:"Ã‡ivi",    icon:"fa-thumbtack",     birimler:["kg", "kutu", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const CATI = [
  { id:"kereste",             ad:"Kereste",             icon:"fa-tree",                birimler:["mÂ³", "adet", "metre"] },
  { id:"osb",                 ad:"OSB",                 icon:"fa-layer-group",         birimler:["adet", "plaka", "mÂ²"] },
  { id:"cati_izalasyonu",     ad:"Ã‡atÄ± Ä°zalasyonu",     icon:"fa-fill-drip",           birimler:["mÂ²", "rulo", "paket"] },
  { id:"kiremit",             ad:"Kiremit",             icon:"fa-th",                  birimler:["adet", "paket", "mÂ²"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const KAPAMA_BETONU = [
  { id:"demir",   ad:"Demir",   icon:"fa-dna",           birimler:["kg", "ton", "adet"] },
  { id:"beton",   ad:"Beton",   icon:"fa-mountain",      birimler:["mÂ³"] },
  { id:"tel",     ad:"Tel",     icon:"fa-wave-square",   birimler:["kg", "m", "rulo"] },
  { id:"civi",    ad:"Ã‡ivi",    icon:"fa-thumbtack",     birimler:["kg", "kutu", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const SAP = [
  { id:"kum",       ad:"Kum",     icon:"fa-mound",       birimler:["ton", "kg", "mÂ³"] },
  { id:"cimento",   ad:"Ã‡imento", icon:"fa-cube",        birimler:["kg", "ton", "torba"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const DUVAR_ORME = [
  { id:"cimento",     ad:"Ã‡imento",         icon:"fa-cube",         birimler:["kg", "ton", "torba"] },
  { id:"duvar_blogu", ad:"Duvar BloÄŸu",    icon:"fa-th-large",     birimler:["adet", "palet", "mÂ²"] },
  { id:"kirec",       ad:"KireÃ§",          icon:"fa-flask",        birimler:["kg", "ton", "torba"] },
  { id:"kum_cakil",   ad:"Kum-Ã‡akÄ±l",      icon:"fa-mound",        birimler:["ton", "kg", "mÂ³"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

// Her kombinasyonda ayrÄ± veri
const odemeData = {};
const evrakData = {};

let aktifAdimId = null, aktifAltKalem = null;

// AdÄ±m butonlarÄ±nÄ± oluÅŸtur
const stepsRowEl = document.querySelector('.uretim-steps-row');
stepsRowEl.innerHTML = '';
URETIM_ADIMLARI.forEach((adim, idx) => {
  const btn = document.createElement('button');
  btn.type = "button";
  btn.className = "uretim-step-btn btn btn-outline-primary";
  btn.setAttribute('data-adimid', adim.id);
  btn.innerHTML = `<i class="fa-solid ${adim.icon} me-1"></i>${adim.ad}`;
  stepsRowEl.appendChild(btn);

});

// --- Modal: AdÄ±ma tÄ±klayÄ±nca aÃ§Ä±lÄ±r ---
document.querySelectorAll('.uretim-step-btn').forEach(btn => {  
  btn.addEventListener('click', function(){  
    aktifAdimId = btn.getAttribute('data-adimid');  
    aktifAltKalem = null;  
    const adim = URETIM_ADIMLARI.find(a=>a.id===aktifAdimId);  
    document.getElementById('modalBaslikIkon').innerHTML = `<i class="fa-solid ${adim.icon} me-1"></i>`;  
    document.getElementById('modalBaslikText').textContent = adim.ad;  
    if(aktifAdimId==='radyalTemel'){  
      showRadyalKalemler();  
    } else if(aktifAdimId==='perdeBetonu'){
      showPerdeKalemler();
    } else if(aktifAdimId==='temelIzolasyon'){
      showTemelIzalasyonuKalemler();
    } else if(aktifAdimId==='subasman'){
      showSuBasmanKalemler();
    } else if(aktifAdimId==='zeminBetonu'){
      showZeminBetonuKalemler();
    } else if(aktifAdimId==='katBetonlari'){
      showKatBetonlariKalemler();
    } else if(aktifAdimId==='catiUygulama'){
      showCatiKalemler();
    } else if(aktifAdimId==='kapamaBetonu'){
      showKapamaBetonuKalemler();
    } else if(aktifAdimId==='sap'){
      showSapKalemler();
    } else if(aktifAdimId==='duvarOrme'){
      showDuvarOrmeKalemler();
    } else if(aktifAdimId==='santiyeKurma'){
      showSantiyeKurma();
    } else if(aktifAdimId==='temelKazma'){
      showTemelKazma();
    } else if(aktifAdimId==='groBeton'){
      showGroBeton();
    } else if(aktifAdimId==='dolgu'){
      showDolgu();
    }
    bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();  
  });  
});  

// 1. Radyal Temel alt kalemlerini butonla gÃ¶ster:
function showSantiyeKurma(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Åantiye Kurma - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="santiyeKurmaBtnGrup">${  
        SANTIYE_KURMA.map(kal =>  
          `<button type="button" class="btn btn-outline-primary santiye-kurma-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="santiyeKurmaForm"></div>`;  

  document.querySelectorAll('.santiye-kurma-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Åantiye Kurma - "+ SANTIYE_KURMA.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showSantiyeKurma, aktifAltKalem, SANTIYE_KURMA,"santiyeKurma");
    }  
  });  
}
function showTemelKazma(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Temel Kazma - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="temelKazmaBtnGrup">${  
        TEMEL_KAZMA.map(kal =>  
          `<button type="button" class="btn btn-outline-primary temel-kazma-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="temelKazmaForm"></div>`;  

  document.querySelectorAll('.temel-kazma-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Temel Kazma - "+ TEMEL_KAZMA.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showTemelKazma, aktifAltKalem, TEMEL_KAZMA,"temelKazma");
    }  
  });  
}
function showGroBeton(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Gro Beton - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="groBetonBtnGrup">${  
        GRO_BETON.map(kal =>  
          `<button type="button" class="btn btn-outline-primary gro-beton-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="groBetonForm"></div>`;  

  document.querySelectorAll('.gro-beton-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Gro Beton - "+ GRO_BETON.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showGroBeton, aktifAltKalem, GRO_BETON,"groBeton");
    }  
  });  
}
function showDolgu(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Dolgu - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="dolguBtnGrup">${  
        DOLGU.map(kal =>  
          `<button type="button" class="btn btn-outline-primary dolgu-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="dolguForm"></div>`;  

  document.querySelectorAll('.dolgu-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Dolgu - "+ DOLGU.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showDolgu, aktifAltKalem, DOLGU,"dolgu");
    }  
  });  
}
function showRadyalKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Radyal Temel - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="radyalKalemBtnGrup">${  
        RADYAL_ALTKALEM.map(kal =>  
          `<button type="button" class="btn btn-outline-primary radyal-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="radyalAltKalemForm"></div>`;  

  document.querySelectorAll('.radyal-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Radyal Temel - "+ RADYAL_ALTKALEM.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showRadyalKalemler, aktifAltKalem, RADYAL_ALTKALEM,"radyalTemel");
    }  
  });  
}
function showPerdeKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Perde Beton - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="perdeKalemBtnGrup">${  
        RADYAL_ALTKALEM.map(kal =>  
          `<button type="button" class="btn btn-outline-primary perde-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="perdeAltKalemForm"></div>`;  

  document.querySelectorAll('.perde-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');
      document.getElementById('modalBaslikText').textContent =  
        "Perde Beton - "+ RADYAL_ALTKALEM.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showPerdeKalemler, aktifAltKalem, RADYAL_ALTKALEM,"perdeBetonu");
    }  
  });  
}
function showTemelIzalasyonuKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Temel Ä°zalasyonu - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="temelIzalasyonKalemBtnGrup">${  
        TEMEL_IZALASYONU.map(kal =>  
          `<button type="button" class="btn btn-outline-primary temel_izalasyon-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="temelIzalasyonAltKalemForm"></div>`;  

  document.querySelectorAll('.temel_izalasyon-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Temel Ä°zalasyonu - "+ TEMEL_IZALASYONU.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showTemelIzalasyonuKalemler, aktifAltKalem, TEMEL_IZALASYONU,"temelIzolasyon");
    }  
  });  
}
function showSuBasmanKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Subasman - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="subasmanKalemBtnGrup">${  
        SU_BASMAN.map(kal =>  
          `<button type="button" class="btn btn-outline-primary subasman-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="subasmanAltKalemForm"></div>`;  

  document.querySelectorAll('.subasman-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Subasman - "+ SU_BASMAN.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showSuBasmanKalemler, aktifAltKalem, SU_BASMAN,"subasman");
    }  
  });  
}
function showZeminBetonuKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Zemin Betonu - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="zeminBetonuKalemBtnGrup">${  
        ZEMIN_BETONU.map(kal =>  
          `<button type="button" class="btn btn-outline-primary zemin-betonu-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="zeminBetonuAltKalemForm"></div>`;  

  document.querySelectorAll('.zemin-betonu-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Zemin Betonu - "+ ZEMIN_BETONU.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showZeminBetonuKalemler, aktifAltKalem, ZEMIN_BETONU,"zeminBetonu");
    }  
  });  
}
function showKatBetonlariKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Kat BetonlarÄ± - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="katBetonlariKalemBtnGrup">${  
        KAT_BETONLARI.map(kal =>  
          `<button type="button" class="btn btn-outline-primary kat-betonlari-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="katBetonlariAltKalemForm"></div>`;  

  document.querySelectorAll('.kat-betonlari-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Kat BetonlarÄ± - "+ KAT_BETONLARI.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showKatBetonlariKalemler, aktifAltKalem, KAT_BETONLARI,"katBetonlari");
    }  
  });  
}
function showCatiKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Ã‡atÄ± - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="catiKalemBtnGrup">${  
        CATI.map(kal =>  
          `<button type="button" class="btn btn-outline-primary cati-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="catiAltKalemForm"></div>`;  

  document.querySelectorAll('.cati-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Ã‡atÄ± - "+ CATI.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showCatiKalemler, aktifAltKalem, CATI,"catiUygulama");
    }  
  });  
}
function showKapamaBetonuKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Kapama Betonu - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="kapamaBetonuKalemBtnGrup">${  
        KAPAMA_BETONU.map(kal =>  
          `<button type="button" class="btn btn-outline-primary kapama-betonu-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="kapamaBetonuAltKalemForm"></div>`;  

  document.querySelectorAll('.kapama-betonu-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Kapama Betonu - "+ KAPAMA_BETONU.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showKapamaBetonuKalemler, aktifAltKalem, KAPAMA_BETONU,"kapamaBetonu");
    }  
  });  
}
function showSapKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">ÅAP - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="sapKalemBtnGrup">${  
        SAP.map(kal =>  
          `<button type="button" class="btn btn-outline-primary sap-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="sapAltKalemForm"></div>`;  

  document.querySelectorAll('.sap-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "ÅAP - "+ SAP.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showSapKalemler, aktifAltKalem, SAP,"sap");
    }  
  });  
}
function showDuvarOrmeKalemler(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Duvar Ã–rme - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="duvarOrmeKalemBtnGrup">${  
        DUVAR_ORME.map(kal =>  
          `<button type="button" class="btn btn-outline-primary duvar-orme-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="duvarOrmeAltKalemForm"></div>`;  

  document.querySelectorAll('.duvar-orme-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Duvar Ã–rme - "+ DUVAR_ORME.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showDuvarOrmeKalemler, aktifAltKalem, DUVAR_ORME,"duvarOrme");
    }  
  });  
}


const INCE_URETIM_ADIMLARI = [
  { id: 'zeminUygulamalari',  ad: "Zemin UygulamalarÄ±",  icon: "fa-grip-lines" }, // veya "fa-border-none", "fa-th-large"
  { id: 'icCephe',            ad: "Ä°Ã§ Cephe",            icon: "fa-home" }, // "fa-paint-roller" da olabilir
  { id: 'islakMekanlar',      ad: "Islak Mekanlar",      icon: "fa-shower" },
  { id: 'mutfak',             ad: "Mutfak",              icon: "fa-utensils" }, // veya "fa-kitchen-set" FA6+
  { id: 'pimapen',            ad: "Pimapen",             icon: "fa-window-maximize" }, // pencere iÃ§in
  { id: 'kapilar',            ad: "KapÄ±lar",             icon: "fa-door-open" },
  { id: 'korkuluklar',        ad: "Korkuluklar",         icon: "fa-grip-vertical" }, // veya "fa-archway" veya "fa-bars"
  { id: 'disCephe',           ad: "DÄ±ÅŸ Cephe",           icon: "fa-city" }, // veya "fa-building", "fa-warehouse"
  { id: 'mantolama',          ad: "Mantolama",           icon: "fa-th-large" },//fa-layer-group, fa-fill-drip
  { id: 'tavan',              ad: "Tavan",               icon: "fa-border-top-left" }, // En uygun FA6+, FA5 yoksa "fa-grip-lines"
  { id: 'elektrikTesisat',    ad: "Elektrik Tesisat",    icon: "fa-bolt" }, // yÄ±ldÄ±rÄ±m
  { id: 'sihhiTesisat',       ad: "SÄ±hhi Tesisat",       icon: "fa-faucet" }, // musluk (FA6+), FA5'te "fa-tint"
  { id: 'dogalgaz',           ad: "DoÄŸalgaz",            icon: "fa-fire-flame-simple" }, // alev FA6+, FA5 "fa-fire"
  { id: 'asansorKurulumu',    ad: "AsansÃ¶r Kurulumu",    icon: "fa-elevator" }, // FA6+; FA5'te "fa-arrow-up", "fa-arrow-down"
  { id: 'iklimlendirme',      ad: "Ä°klimlendirme",       icon: "fa-fan" }, // veya "fa-wind", "fa-snowflake" (klima/Ä±sÄ±tma)
  { id: 'peyzaj',             ad: "Peyzaj",              icon: "fa-seedling" } // bitki, Ã§im
];

const ZEMIN_UYGULAMALARI = [
  { id:"seramik",     ad:"Seramik",        icon:"fa-border-none",      birimler:["mÂ²", "kutu", "adet"] },
  { id:"parke",       ad:"Parke",          icon:"fa-grip-lines",       birimler:["mÂ²", "paket", "adet"] },
  { id:"mermer",      ad:"Mermer",         icon:"fa-gem",              birimler:["mÂ²", "adet", "plaka"] },
  { id:"zeminBoyasi", ad:"Zemin BoyasÄ±",   icon:"fa-paint-roller",     birimler:["kg", "litre", "kova"] },
  { id:"epoksi",      ad:"Epoksi",         icon:"fa-flask",            birimler:["kg", "litre", "set"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const ELEKTRIK_TESISAT = [
  {id: "elektrikIsciligi", ad: "Elektrik Ä°ÅŸÃ§iliÄŸi", icon: "fa-bolt", birimler: ["metre", "adet", "nokta", "pano", "saat", "gÃ¼n"]},
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const SIHHI_TESISAT = [
  { id:"pisSu",     ad:"Pis Su",      icon:"fa-toilet",              birimler:["metre", "boru", "adet"] },
  { id:"temizSu",   ad:"Temiz Su",    icon:"fa-faucet",              birimler:["metre", "boru", "adet"] },
  { id:"isitma",    ad:"IsÄ±tma",      icon:"fa-temperature-high",    birimler:["metre", "boru", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const IC_CEPHE = [
  { id:"korKasa",       ad:"KÃ¶r Kasa",         icon:"fa-door-closed",      birimler:["metre", "adet"] },
  { id:"kosebent",      ad:"KÃ¶ÅŸebent",         icon:"fa-ruler-combined",   birimler:["metre", "adet"] },
  { id:"betonAstari",   ad:"Beton AstarÄ±",     icon:"fa-fill-drip",        birimler:["kg", "litre"] },
  { id:"alci",          ad:"AlÃ§Ä±",             icon:"fa-snowflake",        birimler:["kg", "torba"] },
  { id:"cimento",       ad:"Ã‡imento",          icon:"fa-cube",             birimler:["kg", "torba"] },
  { id:"kum",           ad:"Kum",              icon:"fa-mound",            birimler:["ton", "kg", "mÂ³"] },
  { id:"hazirSivaIc",   ad:"HazÄ±r SÄ±va Ä°Ã§",    icon:"fa-trowel",           birimler:["kg", "torba", "adet"] },
  { id:"icCepheBoyasi", ad:"Ä°Ã§ Cephe BoyasÄ±",  icon:"fa-paint-roller",     birimler:["kg", "litre", "kova"] },
  { id:"boyaAstari",    ad:"Boya AstarÄ±",      icon:"fa-brush",            birimler:["kg", "litre"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const TAVAN = [
  { id:"stropiyer", ad:"Stropiyer", icon:"fa-wave-square",        birimler:["metre", "adet", "paket"] },
  { id:"alcipan",   ad:"AlÃ§Ä±pan",   icon:"fa-layer-group",        birimler:["mÂ²", "levha", "adet"] },
  { id:"karolem",   ad:"Karolem",   icon:"fa-th-large",           birimler:["adet", "kutu"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const PIMAPEN = [
  { id:"pencereler",    ad:"Pencereler",      icon:"fa-window-maximize",   birimler:["adet", "mÂ²"] },
  { id:"zeminDograma",  ad:"Zemin DoÄŸrama",   icon:"fa-vector-square",     birimler:["metre", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const KAPILAR = [
  { id:"odaKapilari",   ad:"Oda KapÄ±larÄ±",     icon:"fa-door-open",      birimler:["adet"] },
  { id:"celikKapilar",  ad:"Ã‡elik KapÄ±lar",    icon:"fa-shield-alt",     birimler:["adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];

const PEYZAJ = [
  { id:"bahceDuvari",   ad:"BahÃ§e DuvarÄ±",     icon:"fa-border-style",          birimler:["metre", "adet", "mÂ²"] },
  { id:"bitkilendirme", ad:"Bitkilendirme",    icon:"fa-seedling",              birimler:["adet", "mÂ²"] },
  { id:"perforje",      ad:"Perforje",         icon:"fa-grip-lines-vertical",   birimler:["metre", "adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const MUTFAK = [
  { id: "tezgah",           ad: "Tezgah",           icon: "fa-grip-horizontal", birimler: ["metre", "mÂ²"] },
  { id: "mutfakEvye",       ad: "Mutfak Evye",      icon: "fa-sink",           birimler: ["adet", "takÄ±m"] },
  { id: "mutfakDolabi",     ad: "Mutfak DolabÄ±",    icon: "fa-box-archive",    birimler: ["metre", "mÂ²", "adet", "takÄ±m"] },
  { id: "mutfakBataryasi",  ad: "Mutfak BataryasÄ±", icon: "fa-faucet",         birimler: ["adet", "takÄ±m"] },
  { id: "ankastre",         ad: "Ankastre",         icon: "fa-rectangle-list", birimler: ["adet", "set"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const ISLAK_MEKANLAR = [
  { id:"zeminYalitimi",   ad:"Zemin YalÄ±tÄ±mÄ±",    icon:"fa-water",        birimler:["mÂ²"] },
  { id:"seramikFayans",   ad:"Seramik Fayans",    icon:"fa-th",           birimler:["mÂ²", "kutu", "adet"] },
  { id:"klozetler",       ad:"Klozetler",         icon:"fa-toilet",       birimler:["adet", "takÄ±m"] },
  { id:"lavabolar",       ad:"Lavabolar",         icon:"fa-sink",         birimler:["adet", "takÄ±m"] },
  { id:"banyoDolabi",     ad:"Banyo DolabÄ±",      icon:"fa-box-archive",  birimler:["adet", "takÄ±m"] },
  { id:"dusTeknesi",      ad:"DuÅŸ Teknesi",       icon:"fa-shower",       birimler:["adet", "takÄ±m"] },
  { id:"banyoBataryasi",  ad:"Banyo BataryasÄ±",   icon:"fa-faucet",       birimler:["adet", "takÄ±m"] },
  { id:"lavaboBataryasi", ad:"Lavabo BataryasÄ±",  icon:"fa-faucet-drip",  birimler:["adet", "takÄ±m"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const IKLIMLENDIRME = [
  { id: "kombi", ad: "Kombi", icon: "fa-fire", birimler: ["adet", "set"] },
  { id: "kombiDolabi", ad: "Kombi DolabÄ±", icon: "fa-box-archive", birimler: ["adet"] },
  { id: "klima", ad: "Klima", icon: "fa-wind", birimler: ["adet", "set"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const DIS_CEPHE = [
  { id: "hazirSivaDis", ad: "HazÄ±r SÄ±va DÄ±ÅŸ", icon: "fa-fill-drip", birimler: ["kg", "torba", "adet"] },
  { id: "cimento", ad: "Ã‡imento", icon: "fa-cube", birimler: ["kg", "torba"] },
  { id: "kum", ad: "Kum", icon: "fa-mountain", birimler: ["ton", "kg", "mÂ³"] },
  { id: "disCepheBoyasi", ad: "DÄ±ÅŸ cephe BoyasÄ±", icon: "fa-paint-roller", birimler: ["kg", "litre", "kova"] },
  { id: "sove", ad: "SÃ¶ve", icon: "fa-border-none", birimler: ["metre", "adet", "mÂ²"] },
  { id: "boyaAstari", ad: "Boya AstarÄ±", icon: "fa-brush", birimler: ["kg", "litre"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const MANTOLAMA = [
  //{ id: "yuzey_hazirlik",   ad: "YÃ¼zey HazÄ±rlÄ±ÄŸÄ± ve Temizlik", icon: "fa-broom",         birimler: ["mÂ²", "adet"] },
  { id: "duvel_montaj",     ad: "DÃ¼bel ve Aksesuar",   icon: "fa-screwdriver",   birimler: ["adet"] },
  { id: "yalitim_levha",    ad: "YalÄ±tÄ±m LevhasÄ±",     icon: "fa-layer-group",   birimler: ["mÂ²", "adet"] },
  { id: "karbonluEps",      ad: "Karbonlu EPS",                icon: "fa-dice-d6",       birimler: ["mÂ²", "mÂ³", "adet"] },
  { id: "xps",              ad: "XPS",                         icon: "fa-layer-group",   birimler: ["mÂ²", "mÂ³", "adet"] },
  { id: "tasYunu",          ad: "TaÅŸ YÃ¼nÃ¼",                    icon: "fa-feather-alt",   birimler: ["mÂ²", "mÂ³", "adet"] },
  { id: "file_siva",        ad: "DonatÄ± File ve SÄ±va",         icon: "fa-grip-lines",    birimler: ["mÂ²"] },
  { id: "kaplama_siva",     ad: "Ä°kinci Kat SÄ±va",             icon: "fa-fill-drip",     birimler: ["mÂ²"] },
  { id: "dekoratif_kaplama",ad: "Dekoratif/Son Kat Kaplama",   icon: "fa-border-none",   birimler: ["mÂ²"] },
  //{ id: "profil_kose",      ad: "Profil ve KÃ¶ÅŸe DetayÄ±",       icon: "fa-vector-square", birimler: ["metre", "adet"] },
  //{ id: "derz_mastik",      ad: "Derz/SÄ±zdÄ±rmazlÄ±k Mastik",    icon: "fa-pen-fancy",     birimler: ["metre", "adet"] },
  //{ id: "temizlik",         ad: "Temizlik ve AtÄ±k UzaklaÅŸtÄ±rma",icon:"fa-trash-alt",     birimler: ["gÃ¼n", "adet"] },
  //{ id: "numune_test",      ad: "Numune ve Kalite Testleri",   icon: "fa-vials",         birimler: ["adet"] },
  //{ id: "iskele",           ad: "Ä°skele Kurulumu/SÃ¶kÃ¼mÃ¼",      icon: "fa-ladder-water",  birimler: ["mÂ²", "gÃ¼n"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const KORKULUKLAR = [
  { id: "balkon", ad: "Balkon",icon: "fa-grip-lines-vertical", birimler: ["metre", "adet", "kg", "mÂ²"]},
  { id: "merdiven", ad: "Merdiven", icon: "fa-stairs", birimler: ["metre", "adet", "kg", "mÂ²"]},
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const DOGALGAZ = [
  { id: "dogalgazKurulumu", ad: "DoÄŸalgaz Kurulumu", icon: "fa-fire", birimler: ["adet"] },
  ///{ id: "proje_onay", ad: "Proje ve Onay Ä°ÅŸleri", icon: "fa-file-signature", birimler: ["adet"] },
  //{ id: "boru_temini", ad: "Boru Temini ve DÃ¶ÅŸenmesi", icon: "fa-grip-lines", birimler: ["metre", "adet"] },
  //{ id: "kazÄ±", ad: "Hat KazÄ±sÄ±", icon: "fa-person-digging", birimler: ["metre", "mÂ³"] },
  ///{ id: "kaynak_montaj", ad: "Kaynak ve Montaj", icon: "fa-link", birimler: ["adet"] },
  //{ id: "test", ad: "Gaz KaÃ§ak Testi ve Kontrol", icon: "fa-vial", birimler: ["adet"] },
  //{ id: "yalitÄ±m", ad: "Boru YalÄ±tÄ±mÄ± ve Kaplama", icon: "fa-fill-drip", birimler: ["metre"] },
  ///{ id: "regulator_sayac", ad: "RegÃ¼latÃ¶r ve SayaÃ§ MontajÄ±", icon: "fa-tachometer-alt", birimler: ["adet"] },
  ///{ id: "kombibas", ad: "Kombi/KazancÄ± MontajÄ±", icon: "fa-fire", birimler: ["adet"] },
  //{ id: "vana_montaji", ad: "Vana ve ArmatÃ¼r MontajÄ±", icon: "fa-toggle-on", birimler: ["adet"] },
  ///{ id: "alarm", ad: "Gaz Alarm Sistemi Kurulumu", icon: "fa-bell", birimler: ["adet"] },
  //{ id: "etiket_belge", ad: "Etiketleme ve Belgeler", icon: "fa-id-badge", birimler: ["adet"] },
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet", "kg", "torba","litre","metre","mÂ²", "mÂ³","kova","ton"] }
];
const ASANSOR = [
  { id: "asansorKurulumu", ad: "AsansÃ¶r Kurulumu", icon: "fa-grip-lines-vertical", birimler: ["adet"] },
  /*
  { id: "kuyu_hazirlik", ad: "Kuyu HazÄ±rlÄ±ÄŸÄ± ve Temizlik", icon: "fa-broom", birimler: ["adet"] },
  { id: "ray_montaj", ad: "Ray MontajÄ±", icon: "fa-grip-lines-vertical", birimler: ["metre", "adet"] },
  { id: "makine_daeresi", ad: "Makine Dairesi ve Ana Makine Kurulumu", icon: "fa-cogs", birimler: ["adet"] },
  { id: "kabin_montaj", ad: "Kabin MontajÄ±", icon: "fa-cube", birimler: ["adet"] },
  { id: "karsilik_agirlik", ad: "KarÅŸÄ± AÄŸÄ±rlÄ±k MontajÄ±", icon: "fa-balance-scale", birimler: ["adet"] },
  { id: "halat", ad: "Halat ve TaÅŸÄ±yÄ±cÄ± Sistem MontajÄ±", icon: "fa-stream", birimler: ["metre"] },
  { id: "kapi_montaj", ad: "KapÄ±larÄ±n MontajÄ±", icon: "fa-door-closed", birimler: ["adet"] },
  { id: "elektrik", ad: "Elektrik TesisatÄ± ve Pano Kurulumu", icon: "fa-bolt", birimler: ["adet"] },
  { id: "aydinlatma", ad: "Kuyu Ä°Ã§ AydÄ±nlatma ve GÃ¼venlik", icon: "fa-lightbulb", birimler: ["adet"] },
  { id: "kontrol_sistem", ad: "Kontrol ve Otomasyon Sistemleri", icon: "fa-memory", birimler: ["adet", "kat"] },
  { id: "test_devreye", ad: "Test ve Devreye Alma", icon: "fa-vials", birimler: ["adet"] },
  { id: "ruhsat", ad: "RuhsatlandÄ±rma ve Kabul", icon: "fa-file-contract", birimler: ["adet"] },
  { id: "egitim_dokuman", ad: "EÄŸitim ve DokÃ¼mantasyon", icon: "fa-book", birimler: ["adet"] },
  { id: "bakim_garanti", ad: "BakÄ±m ve Garanti", icon: "fa-wrench", birimler: ["adet", "yÄ±l"] },
  */
  { id: "diger", ad: "DiÄŸer", icon: "fa-ellipsis", birimler: ["adet"] }
];

// Ä°nce Ãœretim adÄ±mlarÄ±nÄ± buton olarak oluÅŸtur
const inceStepsRowEl = document.querySelector('#inceUretim .uretim-steps-row');
if(inceStepsRowEl){
  inceStepsRowEl.innerHTML = '';
  INCE_URETIM_ADIMLARI.forEach((adim, idx) => {
    const btn = document.createElement('button');
    btn.type = "button";
    btn.className = "uretim-step-btn btn btn-outline-secondary"; // Rengi ayÄ±r edebilirsin
    btn.setAttribute('data-adimid', adim.id);
    btn.innerHTML = `<i class="fa-solid ${adim.icon} me-1"></i>${adim.ad}`;
    inceStepsRowEl.appendChild(btn);

  });

  // Event listener ekle
  inceStepsRowEl.querySelectorAll('.uretim-step-btn').forEach(btn => {
    btn.addEventListener('click', function(){
      aktifAdimId = btn.getAttribute('data-adimid');
      aktifAltKalem = null;
      const adim = INCE_URETIM_ADIMLARI.find(a=>a.id === aktifAdimId);
      document.getElementById('modalBaslikIkon').innerHTML = `<i class="fa-solid ${adim.icon} me-1"></i>`;
      document.getElementById('modalBaslikText').textContent = adim.ad;
      if (aktifAdimId === 'zeminUygulamalari') {
        showZeminUygulamalari();
      } else if(aktifAdimId === 'sihhiTesisat'){
        showSihhiTesisat();
      } else if(aktifAdimId === 'icCephe'){
        showIcCephe();
      } else if(aktifAdimId === 'tavan'){
        showTavan();
      } else if(aktifAdimId === 'pimapen'){
        showPimapen();
      } else if(aktifAdimId === 'kapilar'){
        showKapilar();
      } else if(aktifAdimId === 'peyzaj'){
        showPeyzaj();
      } else if(aktifAdimId === 'mutfak'){
        showMutfak();
      } else if(aktifAdimId === 'islakMekanlar'){
        showIslakMekanlar();
      } else if(aktifAdimId === 'iklimlendirme'){
        showIklimlendirme();
      } else if(aktifAdimId === 'disCephe'){
        showDisCephe();
      } else if(aktifAdimId === 'korkuluklar'){
        showKorkuluklar();
      } else if(aktifAdimId === 'elektrikTesisat'){
        showElektrikTesisat();
      } else if(aktifAdimId === 'dogalgaz'){
        showDogalgaz();
      } else if(aktifAdimId === 'asansorKurulumu'){
        showAsansorKurulumu();
      } else if(aktifAdimId === 'mantolama'){
        showMantolama();
      }
      //showOdemeEvrakForm();
      bootstrap.Modal.getOrCreateInstance(document.getElementById('modalUretim')).show();
    });
  });
}

function showZeminUygulamalari(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Zemin UygulamalarÄ± - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="zeminUygulamalariBtnGrup">${  
        ZEMIN_UYGULAMALARI.map(kal =>  
          `<button type="button" class="btn btn-outline-primary zemin-uygulamalari-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="zeminUygulamalariAltKalemForm"></div>`;  

  document.querySelectorAll('.zemin-uygulamalari-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Zemin UygulamalarÄ± - "+ ZEMIN_UYGULAMALARI.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showZeminUygulamalari, aktifAltKalem, ZEMIN_UYGULAMALARI,"zeminUygulamalari");
    }  
  });  
}
function showElektrikTesisat(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Elektrik Tesisat - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="elektrikTesisatBtnGrup">${  
        ELEKTRIK_TESISAT.map(kal =>  
          `<button type="button" class="btn btn-outline-primary elektrik-tesisat-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="elektrikTesisatAltKalemForm"></div>`;  

  document.querySelectorAll('.elektrik-tesisat-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Elektrik Tesisat - "+ ELEKTRIK_TESISAT.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakFormIslem(true, false, showElektrikTesisat, aktifAltKalem, ELEKTRIK_TESISAT,"elektrikTesisat");
    }  
  });  
}
function showSihhiTesisat(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">SÄ±hhi Tesisat - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="sihhiTesisatBtnGrup">${  
        SIHHI_TESISAT.map(kal =>  
          `<button type="button" class="btn btn-outline-primary sihhi-tesisat-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="sihhiTesisatAltKalemForm"></div>`;  

  document.querySelectorAll('.sihhi-tesisat-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "SÄ±hhi Tesisat - "+ SIHHI_TESISAT.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showSihhiTesisat, aktifAltKalem, SIHHI_TESISAT,"sihhiTesisat");
    }  
  });  
}
function showIcCephe(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Ä°Ã§ Cephe - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="icCepheBtnGrup">${  
        IC_CEPHE.map(kal =>  
          `<button type="button" class="btn btn-outline-primary ic-cephe-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="icCepheAltKalemForm"></div>`;  

  document.querySelectorAll('.ic-cephe-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Ä°Ã§ Cephe - "+ IC_CEPHE.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showIcCephe, aktifAltKalem, IC_CEPHE,"icCephe");
    }  
  });  
}
function showTavan(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Tavan - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="tavanBtnGrup">${  
        TAVAN.map(kal =>  
          `<button type="button" class="btn btn-outline-primary tavan-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="tavanAltKalemForm"></div>`;  

  document.querySelectorAll('.tavan-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Tavan - "+ TAVAN.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showTavan, aktifAltKalem, TAVAN,"tavan");
    }  
  });  
}
function showPimapen(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Pimapen - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="pimapenBtnGrup">${  
        PIMAPEN.map(kal =>  
          `<button type="button" class="btn btn-outline-primary pimapen-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="pimapenAltKalemForm"></div>`;  

  document.querySelectorAll('.pimapen-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Pimapen - "+ PIMAPEN.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showPimapen, aktifAltKalem, PIMAPEN,"pimapen");
    }  
  });  
}
function showKapilar(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">KapÄ±lar - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="kapilarBtnGrup">${  
        KAPILAR.map(kal =>  
          `<button type="button" class="btn btn-outline-primary kapilar-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="kapilarAltKalemForm"></div>`;  

  document.querySelectorAll('.kapilar-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "KapÄ±lar - "+ KAPILAR.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showKapilar, aktifAltKalem, KAPILAR,"kapilar");
    }  
  });  
}
function showPeyzaj(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Peyzaj - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="peyzajBtnGrup">${  
        PEYZAJ.map(kal =>  
          `<button type="button" class="btn btn-outline-primary peyzaj-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="peyzajAltKalemForm"></div>`;  

  document.querySelectorAll('.peyzaj-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Peyzaj - "+ PEYZAJ.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showPeyzaj, aktifAltKalem, PEYZAJ,"peyzaj");
    }  
  });  
}
function showMutfak(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Mutfak - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="mutfakBtnGrup">${  
        MUTFAK.map(kal =>  
          `<button type="button" class="btn btn-outline-primary mutfak-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="mutfakAltKalemForm"></div>`;  

  document.querySelectorAll('.mutfak-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Mutfak - "+ MUTFAK.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showMutfak, aktifAltKalem, MUTFAK,"mutfak");
    }  
  });  
}
function showIslakMekanlar(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Islak Mekanlar - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="islakMekanlarBtnGrup">${  
        ISLAK_MEKANLAR.map(kal =>  
          `<button type="button" class="btn btn-outline-primary islak-mekanlar-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="islakMekanlarAltKalemForm"></div>`;  

  document.querySelectorAll('.islak-mekanlar-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Islak Mekanlar - "+ ISLAK_MEKANLAR.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showIslakMekanlar, aktifAltKalem, ISLAK_MEKANLAR, "islakMekanlar");
    }  
  });  
}
function showIklimlendirme(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Ä°klimlendirme - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="iklimlendirmeBtnGrup">${  
        IKLIMLENDIRME.map(kal =>  
          `<button type="button" class="btn btn-outline-primary iklimlendirme-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="iklimlendirmeAltKalemForm"></div>`;  

  document.querySelectorAll('.iklimlendirme-altkalem-btn').forEach(b=>{  
    b.onclick = function(){  
      aktifAltKalem = this.getAttribute('data-kalem');  
      document.getElementById('modalBaslikText').textContent =  
        "Ä°klimlendirme - "+ IKLIMLENDIRME.find(x=>x.id===aktifAltKalem).ad;  
      showOdemeEvrakForm(true, false, showIklimlendirme, aktifAltKalem, IKLIMLENDIRME,"iklimlendirme");
    }  
  });  
}
function showDisCephe(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">DÄ±ÅŸ Cephe - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="disCepheBtnGrup">${  
        DIS_CEPHE.map(kal =>  
          `<button type="button" class="btn btn-outline-primary dis-cephe-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="disCepheAltKalemForm"></div>`;  

  document.querySelectorAll('.dis-cephe-altkalem-btn').forEach(b=>{  
    b.onclick = function() {
      aktifAltKalem = this.getAttribute('data-kalem');
      document.getElementById('modalBaslikText').textContent =
        "DÄ±ÅŸ Cephe - " + DIS_CEPHE.find(x=>x.id===aktifAltKalem).ad;
      showOdemeEvrakForm(true, false, showDisCephe, aktifAltKalem, DIS_CEPHE,"disCephe");
    }
  });  
}
function showKorkuluklar(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Korkuluklar - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="korkuluklarBtnGrup">${  
        KORKULUKLAR.map(kal =>  
          `<button type="button" class="btn btn-outline-primary korkuluklar-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="korkuluklarAltKalemForm"></div>`;  

  document.querySelectorAll('.korkuluklar-altkalem-btn').forEach(b=>{  
    b.onclick = function() {
      aktifAltKalem = this.getAttribute('data-kalem');
      document.getElementById('modalBaslikText').textContent =
        "Korkuluklar - " + KORKULUKLAR.find(x=>x.id===aktifAltKalem).ad;
      showOdemeEvrakForm(true, false, showKorkuluklar, aktifAltKalem, KORKULUKLAR,"korkuluklar");
    }
  });  
}
function showDogalgaz(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">DoÄŸalgaz - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="dogalgazBtnGrup">${  
        DOGALGAZ.map(kal =>  
          `<button type="button" class="btn btn-outline-primary dogalgaz-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="dogalgazAltKalemForm"></div>`;  

  document.querySelectorAll('.dogalgaz-altkalem-btn').forEach(b=>{  
    b.onclick = function() {
      aktifAltKalem = this.getAttribute('data-kalem');
      document.getElementById('modalBaslikText').textContent =
        "DoÄŸalgaz - " + DOGALGAZ.find(x=>x.id===aktifAltKalem).ad;
      showOdemeEvrakFormIslem(true, false, showDogalgaz, aktifAltKalem, DOGALGAZ,"dogalgaz");
    }
  });  
}
function showAsansorKurulumu(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">AsansÃ¶r Kurulumu - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="asansorKurulumuBtnGrup">${  
        ASANSOR.map(kal =>  
          `<button type="button" class="btn btn-outline-primary asansor-kurulumu-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="asansorKurulumuAltKalemForm"></div>`;  

  document.querySelectorAll('.asansor-kurulumu-altkalem-btn').forEach(b=>{  
    b.onclick = function() {
      aktifAltKalem = this.getAttribute('data-kalem');
      document.getElementById('modalBaslikText').textContent =
        "AsansÃ¶r Kurulumu - " + ASANSOR.find(x=>x.id===aktifAltKalem).ad;
      showOdemeEvrakFormIslem(true, false, showAsansorKurulumu, aktifAltKalem, ASANSOR, "asansorKurulumu");
    }
  });  
}
function showMantolama(){  
  document.getElementById('modalContentGenel').innerHTML =  
    `<div class="mb-3">  
      <div class="fw-bold fs-5 mb-2 text-center">Mantolama - Alt Kalem SeÃ§iniz:</div>  
      <div class="d-flex flex-wrap justify-content-center gap-3 mb-3" id="mantolamaBtnGrup">${  
        MANTOLAMA.map(kal =>  
          `<button type="button" class="btn btn-outline-primary mantolama-altkalem-btn mb-2"  
            data-kalem="${kal.id}">  
              <i class="fa-solid ${kal.icon} me-1"></i>${kal.ad}  
          </button>`  
        ).join("")  
      }</div>  
    </div>  
    <div id="mantolamaAltKalemForm"></div>`;  

  document.querySelectorAll('.mantolama-altkalem-btn').forEach(b=>{  
    b.onclick = function() {
      aktifAltKalem = this.getAttribute('data-kalem');
      document.getElementById('modalBaslikText').textContent =
        "Mantolama - " + MANTOLAMA.find(x=>x.id===aktifAltKalem).ad;
      showOdemeEvrakForm(true, false, showMantolama, aktifAltKalem, MANTOLAMA, "mantolama");
    }
  });  
}


function showOdemeEvrakForm(isRadyal = false, isEvrakIsleri = false, geriHandler = null, altKalemId = null, kayitDizisi = null, kalemIdInput) {
  let alanAciklamasi = '';
  aktifKalemId = altKalemId;
  kalemId = kalemIdInput;
  if(isEvrakIsleri) {
    alanAciklamasi = `<div class="alert alert-info py-2 mb-2"> <b>${aktifEvrakKurum} - ${aktifEvrakDetay}</b> iÅŸlemi iÃ§in Ã¶deme ve evrak ekleyin.</div>`;
  }
  // Hangisini gÃ¶nderdiyse oradan bak!
  kayitDizisi = kayitDizisi || DIS_CEPHE;
  const secilenKalem = kayitDizisi.find(x => x.id === altKalemId);
  const birimListesi = (secilenKalem && secilenKalem.birimler) ? secilenKalem.birimler : ['adet'];

  document.getElementById('modalContentGenel').innerHTML = `
    ${isRadyal? `  
    <div class="mb-2">  
      <button type="button" class="btn btn-link btn-sm ps-0 mb-2" id="geriRadyalBtn">  
        <i class="fa fa-chevron-left"></i> Alt Kalemler  
      </button>  
    </div>` : ''}
    ${alanAciklamasi}
    <div class="rowg">
      <div class="colg">
        <div class="card shadow-sm mb-3 w-100">
          <div class="card-header bg-light">
            <b class="text-primary"><i class="fa-solid fa-coins"></i> Ã–deme KayÄ±tlarÄ±</b>
          </div>
          <div class="card-body">
            <form id="odemeFormDinamik">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <input type="text" class="form-control" id="odemeAciklama" placeholder="AÃ§Ä±klama" maxlength="100" required>
                </div>
                <div class="col-md-2">
                  <select class="form-select" id="odemeBirim" required>
                    ${birimListesi.map(birim => `<option value="${birim}">${birim}</option>`).join("")}
                  </select>
                </div>
                <div class="col-md-2">
                  <input type="text" class="form-control" id="odemeMiktar" placeholder="Miktar" min="1" step="any" required>
                </div>
                <div class="col-md-2">
                  <input type="text" class="form-control" id="odemeBirimFiyat" placeholder="Birim Fiyat (TL)" min="0" step="any" required>
                </div>
                <div class="col-md-2">
                  <input type="date" class="form-control" id="odemeTarih" required>
                </div>
                <div class="col-md-3 text-end">
                  <div id="odemeToplamTutar" class="fw-bold text-success" style="font-size:1.1em;">Toplam: 0 TL</div>
                </div>
              </div>
              <div class="d-flex justify-content-end mt-2">
                <button type="submit" class="btn btn-success btn-sm"><i class="fa-solid fa-plus"></i> Kaydet</button>
              </div>
            </form>
            <div class="table-responsive mt-3">
              <table class="table table-striped table-hover align-middle small shadow-sm rounded" id="odemeTablosu">
                <thead class="table-primary">
                  <tr>
                    <th>#</th>
                    <th>AÃ§Ä±klama</th>
                    <th>Birim</th>
                    <th>Miktar</th>
                    <th>Toplam Fiyat</th>
                    <th>Tarih</th>
                    <th>Ä°ÅŸlem</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div id="odemeBosMesaj" class="text-center text-secondary mt-3" style="display:none;">HenÃ¼z Ã¶deme kaydÄ± girilmemiÅŸ.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-5 col-12 d-flex flex-column align-items-center mx-auto">
        <div class="card shadow-sm mb-3 w-100">
          <div class="card-header bg-light">
            <b class="text-primary"><i class="fa-solid fa-paperclip"></i> Evrak YÃ¼kle</b>
          </div>
          <div class="card-body pt-3 pb-2">
            <form id="evrakFormDinamik">
              <div class="input-group mb-2">
                <input type="file" class="form-control" id="evrakDosya" name="file" required>
              </div>
              <div class="mb-2">
                <input type="text" class="form-control" id="evrakAciklama" maxlength="100" placeholder="AÃ§Ä±klama (opsiyonel)">
              </div>
              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-upload"></i> YÃ¼kle</button>
              </div>
            </form>
            <hr>
            <div>
              <h6 class="mb-1 text-secondary">YÃ¼klenen Evraklar:</h6>
              <ul class="list-group file-list" id="evrakListesi" style="font-size:0.97rem;"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  // GÃœNÃœN TARÄ°HÄ°NÄ° OTO DOLDUR
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const formatted = `${yyyy}-${mm}-${dd}`;
  document.getElementById('odemeTarih').value = formatted;

  // Geri butonu olayÄ±
  if(isRadyal && typeof geriHandler === 'function') {
    document.getElementById('geriRadyalBtn').onclick = geriHandler;
  }
  document.getElementById('odemeFormDinamik').onsubmit = odemeFormSubmit;
  document.getElementById('evrakFormDinamik').dataset.alanadi = kalemIdInput || "";
  document.getElementById('evrakFormDinamik').dataset.kalemid = altKalemId || "";
  document.getElementById('evrakFormDinamik').onsubmit = evrakFormSubmit;
  tabloGuncelleDinamik(altKalemId, kalemIdInput);
  evrakGuncelleDinamik(kalemIdInput,altKalemId);

  ['odemeMiktar','odemeBirimFiyat'].forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;
    input.addEventListener("input", function(e) {
      this.value = formatNumberWithDots(this.value);
      this.selectionStart = this.selectionEnd = this.value.length;
      updateToplamTutar();
    });
  });

  ['odemeMiktar','odemeBirimFiyat'].forEach(id=>
    document.getElementById(id).addEventListener('input', updateToplamTutar)
  );
  updateToplamTutar();
}

function showOdemeEvrakFormIslem(isRadyal = false, isEvrakIsleri = false, geriHandler = null, altKalemId = null, kayitDizisi = null, kalemIdInput) {
  let alanAciklamasi = '';
  aktifKalemId = altKalemId;
  kalemId = kalemIdInput;
  //console.log("aktifKalemId ",aktifKalemId);
  //console.log("kalemId ",kalemId);
  if(isEvrakIsleri) {
    alanAciklamasi = `<div class="alert alert-info py-2 mb-2"> <b>${aktifEvrakKurum} - ${aktifEvrakDetay}</b> iÅŸlemi iÃ§in Ã¶deme ve evrak ekleyin.</div>`;
  }
  // Hangisini gÃ¶nderdiyse oradan bak!
  kayitDizisi = kayitDizisi || "";
  let secilenKalem = null;
  if(Array.isArray(kayitDizisi)){
    secilenKalem = kayitDizisi.find(x => x.id === altKalemId);
  }
  const birimListesi = (secilenKalem && secilenKalem.birimler) ? secilenKalem.birimler : ['adet'];

  document.getElementById('modalContentGenel').innerHTML = `
    ${isRadyal ? `
    <div class="mb-2">
      <button type="button" class="btn btn-link btn-sm ps-0 mb-2" id="geriRadyalBtn">
        <i class="fa fa-chevron-left"></i> Alt Kalemler
      </button>
    </div>` : ''}
    ${alanAciklamasi}
    <div class="rowg">
      <div class="colg">
        <div class="card shadow-sm mb-3 w-100">
          <div class="card-header bg-light">
            <b class="text-primary"><i class="fa-solid fa-coins"></i> Ã–deme KayÄ±tlarÄ±</b>
          </div>
          <div class="card-body">
            <form id="odemeFormDinamik">
              <div class="row g-2 align-items-end">
                <div class="col-md-4">
                  <input type="text" class="form-control" id="odemeAciklama" placeholder="AÃ§Ä±klama" maxlength="100" required>
                </div>
                <div class="col-md-3">
                  <input type="text" class="form-control" id="odemeBirimFiyat" placeholder="Tutar (TL)" min="0" step="any" required>
                </div>
                <div class="col-md-3">
                  <input type="date" class="form-control" id="odemeTarih" required>
                </div>
                <div class="col-md-2 text-end">
                  <div id="odemeToplamTutar" class="fw-bold text-success" style="font-size:1.1em;"></div>
                </div>
              </div>
              <div class="d-flex justify-content-end mt-2">
                <button type="submit" class="btn btn-success btn-sm"><i class="fa-solid fa-plus"></i> Kaydet</button>
              </div>
            </form>
            <div class="table-responsive mt-3">
              <table class="table table-striped table-hover align-middle small shadow-sm rounded" id="odemeTablosu">
                <thead class="table-primary">
                  <tr>
                    <th>#</th>
                    <th>AÃ§Ä±klama</th>
                    <th>Tutar (TL)</th>
                    <th>Tarih</th>
                    <th>Ä°ÅŸlem</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div id="odemeBosMesaj" class="text-center text-secondary mt-3" style="display:none;">HenÃ¼z Ã¶deme kaydÄ± girilmemiÅŸ.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-5 col-12 d-flex flex-column align-items-center mx-auto">
        <div class="card shadow-sm mb-3 w-100">
          <div class="card-header bg-light">
            <b class="text-primary"><i class="fa-solid fa-paperclip"></i> Evrak YÃ¼kle</b>
          </div>
          <div class="card-body pt-3 pb-2">
            <form id="evrakFormDinamik">
              <div class="input-group mb-2">
                <input type="file" class="form-control" id="evrakDosya" name="file" required>
              </div>
              <div class="mb-2">
                <input type="text" class="form-control" id="evrakAciklama" maxlength="100" placeholder="AÃ§Ä±klama (opsiyonel)">
              </div>
              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-upload"></i> YÃ¼kle</button>
              </div>
            </form>
            <hr>
            <div>
              <h6 class="mb-1 text-secondary">YÃ¼klenen Evraklar:</h6>
              <ul class="list-group file-list" id="evrakListesi" style="font-size:0.97rem;"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  
  // GÃœNÃœN TARÄ°HÄ°NÄ° OTO DOLDUR
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const formatted = `${yyyy}-${mm}-${dd}`;
  document.getElementById('odemeTarih').value = formatted;

  // Geri butonu olayÄ±
  if(isRadyal && typeof geriHandler === 'function') {
    document.getElementById('geriRadyalBtn').onclick = geriHandler;
  }
  document.getElementById('odemeFormDinamik').onsubmit = odemeFormSubmit;
  document.getElementById('evrakFormDinamik').dataset.alanadi = kalemIdInput || "";
  document.getElementById('evrakFormDinamik').dataset.kalemid = altKalemId || "";
  document.getElementById('evrakFormDinamik').onsubmit = evrakFormSubmit;
  tabloGuncelleDinamikIslem(altKalemId, kalemIdInput);
  evrakGuncelleDinamik(kalemIdInput,altKalemId);

  const tutarInput = document.getElementById('odemeBirimFiyat');
  tutarInput.addEventListener("input", function(e) {
    this.value = formatNumberWithDots(this.value);
    this.selectionStart = this.selectionEnd = this.value.length;
    updateToplamTutarIslem();
  });

  updateToplamTutarIslem();
  document.getElementById('odemeBirimFiyat').addEventListener("input", updateToplamTutarIslem);
}

// Otomatik Toplam Hesaplama
function updateToplamTutar() {
  const miktar = toNumberFromInput(document.getElementById('odemeMiktar').value);
  const birimFiyat = toNumberFromInput(document.getElementById('odemeBirimFiyat').value);
  const toplam = miktar * birimFiyat;
  document.getElementById('odemeToplamTutar').innerText =
    `Toplam: ${toplam.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})} TL`;
}
function updateToplamTutarIslem() {
  const birimFiyat = toNumberFromInput(document.getElementById('odemeBirimFiyat').value);
  document.getElementById('odemeToplamTutar').innerText =
    birimFiyat > 0
      ? `Toplam: ${birimFiyat.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})} TL`
      : "";
}
// -- Dinamik Ã¶demeler
// Odeme formunu gÃ¶nder
function odemeFormSubmit(e){
  e.preventDefault();
  const aciklama = document.getElementById('odemeAciklama').value.trim();
  const tarih = document.getElementById('odemeTarih').value.split('-').reverse().join('-');
  let birim = "-";
  let miktar = 1;
  let toplam_func = false;

  // EÄŸer formda bu inputlar varsa, onlardan deÄŸer al
  if(document.getElementById('odemeBirim') && document.getElementById('odemeMiktar')){
    birim = document.getElementById('odemeBirim').value;
    miktar = toNumberFromInput(document.getElementById('odemeMiktar').value);
    toplam_func = true;
  }
  const birimFiyat = toNumberFromInput(document.getElementById('odemeBirimFiyat').value);
  const toplamTutar = (!isNaN(miktar) && !isNaN(birimFiyat)) ? miktar * birimFiyat : 0;
  let kalemKayit = null;

  if(aktifKalemId === "Belediye" || 
    aktifKalemId === "Noter" || 
    aktifKalemId === "YapÄ± Denetim" || 
    aktifKalemId === "Zemin EtÃ¼dÃ¼" || 
    aktifKalemId === "Projeler" ||
    aktifKalemId === "HaritacÄ±" ||
    aktifKalemId === "Ä°ÅŸ GÃ¼venliÄŸi" ||
    aktifKalemId === "Åantiye Elektrik" ||

    aktifKalemId === "Arsa" ||
    aktifKalemId === "Kadastro" ||
    aktifKalemId === "DiÄŸer"
    ){
    kalemKayit = {
      alanAdi: kalemId,
      kalemId: aktifKalemId,
      tarih,
      toplamTutar,
      aciklama
    };

    if(aciklama && toplamTutar > 0 && tarih && aktifKalemId) {
      showLoader();
      console.log("kalemKayit:",kalemKayit);
      fetch('/evrak', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            process:"save",
            userId, 
            projectName,
            kalemKayit 
          })
        })
      .then(r => r.json())
      .then(() => {
        tabloGuncelleDinamikIslem(aktifKalemId, kalemId);
      })
      .finally(() => {
        hideLoader();
    });
      e.target.reset();
      updateToplamTutarIslem();
    }
  } else{
    kalemKayit = {
      alanAdi: kalemId,
      kalemId: aktifKalemId,  // frontend'den gÃ¶nderdiÄŸin kalemin id'si (Ã¶r: "zeminYalitimi")
      miktar,
      birim,
      tarih,
      toplamTutar,
      aciklama
    };
    if(aciklama && toplamTutar > 0 && tarih && aktifKalemId) {
      showLoader();
      fetch('/evrak', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            process:"save",
            userId, 
            projectName,
            kalemKayit,
            birimFiyat
          })
        })
      .then(r => r.json())
      .then(() => {
        if(toplam_func){
          tabloGuncelleDinamik(aktifKalemId, kalemId);
        } else {
          tabloGuncelleDinamikIslem(aktifKalemId, kalemId);
        }
      })
      .finally(() => {
        hideLoader();
    });
      e.target.reset();
      if(toplam_func){
        updateToplamTutar();
      } else{
        updateToplamTutarIslem();
      }
    }
  }

  
  
}
function tabloGuncelleDinamik(aktifKalemId, kalemIdInput) {
  const tbody = document.querySelector('#odemeTablosu tbody');
  showLoader();

  // Aktif kalem id'si olmadan Ã§aÄŸrÄ±lmamalÄ±
  if (!aktifKalemId) {
    tbody.innerHTML = '';
    document.getElementById('odemeBosMesaj').style.display = '';
    document.getElementById('odemeTablosu').style.display = 'none';
    hideLoader();
    return;
  }

  fetch('/evrak', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({
      process: "read",
      userId,
      projectName,
      alanAdi: kalemIdInput,
      kalemId: aktifKalemId // yeni: sadece seÃ§ilen kalem iÃ§in okuma!
    })
  })
    .then(r => r.json())
    .then(veri => {
      tbody.innerHTML = '';
      if (!Array.isArray(veri) || veri.length === 0) {
        document.getElementById('odemeBosMesaj').style.display = '';
        document.getElementById('odemeTablosu').style.display = 'none';
      } else {
        document.getElementById('odemeBosMesaj').style.display = 'none';
        document.getElementById('odemeTablosu').style.display = '';
        veri.forEach((o, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${o.aciklama || ''}</td>
            <td>${o.birim || ''}</td>
            <td>${o.miktar}</td>
            <td>${Number(o.toplamTutar).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span style="color:#0d6efd;font-weight:bold;">â‚º</span></td>
            <td>${o.tarih}</td>
            <td>
              <button class="btn btn-sm btn-danger" title="Sil" onclick="silOdemeSunucu('${o._id}', '${aktifKalemId}', '${kalemIdInput}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
    })
    .finally(() => {
      hideLoader();
    });
}

function tabloGuncelleDinamikIslem(aktifKalemId, kalemIdInput) {
  const tbody = document.querySelector('#odemeTablosu tbody');
  showLoader();

  // Aktif kalem id'si olmadan Ã§aÄŸrÄ±lmamalÄ±
  if (!aktifKalemId) {
    tbody.innerHTML = '';
    document.getElementById('odemeBosMesaj').style.display = '';
    document.getElementById('odemeTablosu').style.display = 'none';
    hideLoader();
    return;
  }

  fetch('/evrak', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({
      process: "read",
      userId,
      projectName,
      alanAdi: kalemIdInput,
      kalemId: aktifKalemId // yeni: sadece seÃ§ilen kalem iÃ§in okuma!
    })
  })
    .then(r => r.json())
    .then(veri => {
      tbody.innerHTML = '';
      if (!Array.isArray(veri) || veri.length === 0) {
        document.getElementById('odemeBosMesaj').style.display = '';
        document.getElementById('odemeTablosu').style.display = 'none';
      } else {
        document.getElementById('odemeBosMesaj').style.display = 'none';
        document.getElementById('odemeTablosu').style.display = '';
        veri.forEach((o, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${o.aciklama || ''}</td>
            <td>${Number(o.toplamTutar).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span style="color:#0d6efd;font-weight:bold;">â‚º</span></td>
            <td>${o.tarih}</td>
            <td>
              <button class="btn btn-sm btn-danger" title="Sil" onclick="silOdemeSunucu('${o._id}', '${aktifKalemId}', '${kalemIdInput}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
    })
    .finally(() => {
      hideLoader();
    });
}
async function silOdemeSunucu(odemeId, altKalemId, kalemIdInput) {
  const userConfirm = await showWarningMessage("KayÄ±t silinsin mi?", "evet", false);
  if (!userConfirm) return;

  let birim = "-";
  let miktar = 1;
  let toplam_func = false;

  // EÄŸer formda bu inputlar varsa, onlardan deÄŸer al
  if(document.getElementById('odemeBirim') && document.getElementById('odemeMiktar')){
    birim = document.getElementById('odemeBirim').value;
    miktar = parseFloat(document.getElementById('odemeMiktar').value);
    toplam_func = true;
  }

  showLoader();

  fetch('/evrak', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      process: "delete",
      userId,
      projectName,
      alanAdi: kalemIdInput,
      odemeId,
      altKalemId // alt kalem idâ€™sini backendâ€™e gÃ¶nderiyoruz!
    })
  })
    .then(r => r.json())
    .then(() => {
        if(toplam_func){
          tabloGuncelleDinamik(aktifKalemId, kalemId);
        } else {
          tabloGuncelleDinamikIslem(aktifKalemId, kalemId);
        }
    })
    .finally(() => {
      hideLoader();
  });
}
window.silOdemeSunucu = silOdemeSunucu;
window.tabloGuncelleDinamik = tabloGuncelleDinamik;
window.tabloGuncelleDinamikIslem = tabloGuncelleDinamikIslem;


async function evrakFormSubmit(e) {
  e.preventDefault();
  const form = e.target;
  const alanAdi = form.dataset.alanadi;
  const kalemSatirId = form.dataset.kalemid;
  const dosyaInput = document.getElementById('evrakDosya');
  const aciklamaInput = document.getElementById('evrakAciklama');
  const dosya = dosyaInput.files[0];
  if (!dosya) return;

  const aciklama = aciklamaInput.value.trim();

  // DosyayÄ± Ã¶nce PDFâ€™e Ã§evir
  let pdfFile;
  try {
    pdfFile = await fileToPdfBlob(dosya);
  } catch(e) {
    dosyaInput.value = "";
    aciklamaInput.value = "";
    showWarningMessage("Dosya PDF veya resim deÄŸil!", "tamam", false);
    return;
  }

  showLoader();

  const formData = new FormData();
  formData.append('file', pdfFile);
  formData.append('aciklama', aciklama);
  formData.append('process', "saveEvrak");
  formData.append('projectName', projectName);
  formData.append('userId', userId);
  formData.append('alanAdi', alanAdi);          // DoÄŸru deÄŸer!
  if (kalemSatirId) formData.append('kalemId', kalemSatirId);

  await fetch('/evrak', {
    method: 'POST',
    body: formData
  });

  evrakGuncelleDinamik(alanAdi, kalemSatirId);

  dosyaInput.value = "";
  aciklamaInput.value = "";
  hideLoader();

  // Form reset
  if (e.target && typeof e.target.reset === 'function') {
    e.target.reset();
  }
}
function fileToPdfBlob(file) {
  return new Promise((resolve, reject) => {
    if (file.type === "application/pdf") {
      // Zaten pdf, dosyayÄ± aynen kullan.
      resolve(file);
    } else if (file.type.startsWith("image/")) {
      // jsPDF ile resmi PDFe koyup blob yapalÄ±m
      const reader = new FileReader();
      reader.onload = function(e) {
        const imgData = e.target.result;
        const pdf = new window.jspdf.jsPDF(); // veya new jsPDF();
        pdf.addImage(imgData, 'JPEG', 10, 10, 180, 250);
        const pdfBlob = pdf.output("blob");
        resolve(new File([pdfBlob], file.name.replace(/\..+$/, ".pdf"), { type: "application/pdf" }));
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    } else {
      // DiÄŸer dosya tÃ¼rleri iÃ§in uyarÄ±
      //alert("Sadece PDF veya resim yÃ¼kleyebilirsiniz!");
      reject("Desteklenmeyen dosya tÃ¼rÃ¼");
    }
  });
}

function evrakGuncelleDinamik(alanAdi, kalemId) {
    //console.log(alanAdi, kalemId);
    const ul = document.getElementById('evrakListesi');
    fetch('/evrak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            process: "readEvrak",
            userId,
            projectName,
            alanAdi,       // "islakMekanlar", "imarDurumu" vs
            kalemId        // ilgili iÅŸ dizisi satÄ±rÄ±nÄ±n _id veya kalemId'si, gerekirse
        })
    })
    .then(r => r.json())
    .then(veri => {
      //console.log("veri:",veri);
        ul.innerHTML = '';
        if (!veri || veri.length === 0) {
            ul.innerHTML = `<li class="list-group-item text-secondary">Evrak yok veya yÃ¼klenmemiÅŸ.</li>`;
        } else {
            veri.forEach(ev => {
                const fileName = ev.fileName || ev.dosyaAdi || "evrak";
                const filePath = ev.path;
                const li = document.createElement('li');
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
                    <span>
                        <i class="fa-solid fa-file-arrow-down me-1"></i>
                        <b>${fileName}</b>
                        <small class="text-muted">${ev.aciklama || ''}</small>
                        <button type="button"
                            class="btn btn-link btn-sm px-0 ms-1"
                            title="GÃ¶rÃ¼ntÃ¼le"
                            onclick="showEvrakModal('${filePath.replace(/'/g,"\\'")}', '${fileName.replace(/'/g,"\\'") }')">
                            <i class="fa fa-eye"></i>
                        </button>
                        <a href="${filePath}" download="${fileName}"
                            class="btn btn-link btn-sm px-0 ms-1" title="Ä°ndir">
                            <i class="fa fa-download"></i>
                        </a>
                    </span>
                    <button class="btn btn-outline-danger btn-sm" title="Sil" onclick="silEvrakSunucu('${ev._id}','${alanAdi}','${kalemId || ""}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                ul.appendChild(li);
            });
        }
    });
}
async function silEvrakSunucu(evrakId, alanAdi, kalemId) {
    const userConfirm = await showWarningMessage("KayÄ±t silinsin mi?", "evet", false);
    if (!userConfirm) return;
    showLoader();
    fetch('/evrak', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            process: "deleteEvrak",
            userId,
            projectName,
            evrakId,
            alanAdi,   // hangi ana dizide dokÃ¼manÄ± sileceÄŸimiz MUST!
            kalemId    // eÄŸer ilgili kalem satÄ±rÄ± ise onun _id ya da kalemId'si
        })
    })
    .then(r => r.json())
    .then(() => evrakGuncelleDinamik(alanAdi, kalemId))  // GÃ¼ncelleme yine doÄŸru parametrelerle
    .finally(() => {
        hideLoader();
    });
}
function showEvrakModal(fileUrl, fileName) {
    let content = '';
    const ext = fileName.split('.').pop().toLowerCase();
    //const isMobile = isMobileDevice();
    const isMobile = false;

    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
        content = `<img src="${fileUrl}" class="img-fluid" alt="${fileName}">`;
    } else if (['pdf'].includes(ext)) {
        if (isMobile) {
            // Sadece buton, uyarÄ± metni
            content = `
                <a href="${fileUrl}" target="_blank" class="btn btn-secondary my-2 w-100 mb-2">
                    PDF'i Yeni Sekmede AÃ§
                </a>
                <div class="alert alert-warning small text-center mt-2 mb-0">
                    PDF gÃ¶rÃ¼ntÃ¼leme mobil tarayÄ±cÄ±larda desteklenmeyebilir.<br>
                    YukarÄ±daki butonu kullanÄ±n.
                </div>
            `;
        } else {
            // Hem iframe hem buton (masaÃ¼stÃ¼)
            content = `
                <a href="${fileUrl}" target="_blank" class="btn btn-secondary my-2 w-100 mb-2">
                    PDF'i Yeni Sekmede AÃ§
                </a>
                <iframe src="${fileUrl}" style="width:100%;min-height:60vh;border:none"></iframe>
                <div class="text-muted small mt-2">
                    PDF'i burada gÃ¶rÃ¼ntÃ¼leyemiyorsanÄ±z butonu kullanÄ±n.
                </div>
            `;
        }
    } else {
        content = `Bu dosya tÃ¼rÃ¼ gÃ¶rÃ¼ntÃ¼lenemiyor.<br>
                   <a href="${fileUrl}" download class="btn btn-primary mt-3">Ä°ndir (${fileName})</a>`;
    }

    document.getElementById('evrakModalLabel').textContent = fileName;
    document.getElementById('evrakModalBody').innerHTML = content;

    const modal = new bootstrap.Modal(document.getElementById('evrakModal'));
    modal.show();
}
function isMobileDevice() {
  // Modern tarayÄ±cÄ±lar iÃ§in oldukÃ§a gÃ¼venli kontrol
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

async function showYerSahibiAnlasmaModal(
  isRadyal = false, isEvrakIsleri = false, geriHandler = null, altKalemId = null, kayitDizisi = null, kalemIdInput
) {
  let alanAciklamasi = '';
  aktifKalemId = altKalemId;
  kalemId = kalemIdInput;
  if (isEvrakIsleri) {
    alanAciklamasi = `<div class="alert alert-info py-2 mb-2"> <b>${aktifEvrakKurum} - ${aktifEvrakDetay}</b> iÅŸlemi iÃ§in Ã¶deme ve evrak ekleyin.</div>`;
  }
  kayitDizisi = kayitDizisi || "";
  let secilenKalem = null;
  if (Array.isArray(kayitDizisi)) {
    secilenKalem = kayitDizisi.find(x => x.id === altKalemId);
  }
  const birimListesi =
    secilenKalem && secilenKalem.birimler ? secilenKalem.birimler : ["adet"];

  // YER SAHÄ°BÄ° ANLAÅMALARI BACKEND'DEN Ã‡EK  
  const yerSahibiCevap = await readYerSahibi();  
  let anlasmaHTML = "";  
  if (yerSahibiCevap && yerSahibiCevap.success && Array.isArray(yerSahibiCevap.yerSahibiIleAnlasma)) {  
    if (yerSahibiCevap.yerSahibiIleAnlasma.length > 0) {  
      anlasmaHTML = yerSahibiCevap.yerSahibiIleAnlasma  
        .map(entry => `
          <div class="card mb-2">
            <div class="card-body px-3 py-2" style="font-size:1em;">
              <div><b>${entry.tarih || ''}</b></div>
              <div>${entry.buildingDetail.kat || ''}</div>
              ${entry.buildingDetail.tipi ? `<div>${entry.buildingDetail.tipi}</div>` : ''}
              ${entry.not ? `<div class="mt-1 text-secondary"><b>${entry.not}</b></div>` : ''}
            </div>
          </div>
        `).join('');  
    } else {  
      anlasmaHTML = `<div class="text-muted small">KayÄ±t yok.</div>`;  
    }  
  } else {  
    anlasmaHTML = `<div class="text-muted small">Veri alÄ±namadÄ±.</div>`;  
  }  

  document.getElementById('modalContentGenel').innerHTML = `  
    <h5>Yer Sahibi ile AnlaÅŸma</h5>  
    <div style="color: #6c757d; font-size: 0.98em; margin-bottom:18px;">  
      Arsa iÃ§in yer sahibi ile kat karÅŸÄ±lÄ±ÄŸÄ± ve/veya para alma/verme Ã¼zerine anlaÅŸÄ±lmÄ±ÅŸsa ilgili yerlere giriniz.  
    </div>  
    <div id="paraOzetAlani" class="alert alert-secondary py-2 mb-3" style="display:none;">  
      <b>Girilen Bilgiler:</b>  
      <ul class="list-unstyled mb-0" id="listeOzet"></ul>  
      <div class="d-flex justify-content-between align-items-center gap-2 mt-2 flex-wrap">  
        <div>  
          <span id="toplamTutarAlani" class="fw-bold text-primary" style="display:none;">Toplam: 0 TL</span>  
          <span id="kalanTutarAlani" class="fw-bold text-success" style="display:none; margin-left:12px;">Kalan: 0 TL</span>  
        </div>  
        <button type="button" id="tumKayitlariSilBtn" class="btn btn-outline-danger btn-sm" style="display:none;">TÃ¼m KayÄ±tlarÄ± Sil</button>  
      </div>  
    </div>  
    <div id="paraAlanContainer"></div>  
    
    <hr class="my-3" style="border-color: #cbd5e1; border-width: 4.5px 0 0 0; opacity:.88;" />  
    
    <button class="btn btn-primary mb-2" id="daireSecBtn">Daire SeÃ§</button>  

    <div id="anlasmaSonucInfoContainer">  
      ${anlasmaHTML}  
    </div>  

    <hr class="my-3" style="border-color: #cbd5e1; border-width: 4.5px 0 0 0; opacity:.88;" />  
    <div class="card shadow-sm mb-0 w-100 mt-4 mb-3">  
      <div class="card-header bg-light">  
        <b class="text-primary"><i class="fa-solid fa-paperclip"></i> Evrak YÃ¼kle</b>  
      </div>  
      <div class="card-body pt-3 pb-2">  
        <form id="evrakFormDinamik" data-alanadi="yerSahibiAnlasma" data-kalemid="Yer Sahibi Ä°le AnlaÅŸma">  
          <div class="input-group mb-2">  
            <input type="file" class="form-control" id="evrakDosya" name="file" required>  
          </div>  
          <div class="mb-2">  
            <input type="text" class="form-control" id="evrakAciklama" maxlength="100" placeholder="AÃ§Ä±klama (opsiyonel)">  
          </div>  
          <div class="d-flex justify-content-end">  
            <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-upload"></i> YÃ¼kle</button>  
          </div>  
        </form>  
        <hr>  
        <div>  
          <h6 class="mb-1 text-secondary">YÃ¼klenen Evraklar:</h6>  
          <ul class="list-group file-list" id="evrakListesi" style="font-size:0.97rem;"></ul>  
        </div>  
      </div>  
    </div>  
  `;

  evrakGuncelleDinamik("yerSahibiAnlasma", "Yer Sahibi Ä°le AnlaÅŸma");

  const evrakForm = document.getElementById('evrakFormDinamik');
  if (evrakForm) {
    const thisProjectName = projectName;
    const thisUserId = userId;

    evrakForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const form = e.target;
      const alanAdi = form.dataset.alanadi;
      const kalemSatirId = form.dataset.kalemid;
      const dosyaInput = document.getElementById('evrakDosya');
      const aciklamaInput = document.getElementById('evrakAciklama');
      const dosya = dosyaInput.files[0];
      if (!dosya) return;

      const aciklama = aciklamaInput.value.trim();

      let pdfFile;
      try {
        pdfFile = await fileToPdfBlob(dosya);
      } catch(e) {
        dosyaInput.value = "";
        aciklamaInput.value = "";
        showWarningMessage("Dosya PDF veya resim deÄŸil!", "tamam", false);
        return;
      }

      showLoader();

      const formData = new FormData();
      formData.append('file', pdfFile);
      formData.append('aciklama', aciklama);
      formData.append('process', "saveEvrak");
      formData.append('projectName', thisProjectName);
      formData.append('userId', thisUserId);
      formData.append('alanAdi', alanAdi);
      if (kalemSatirId) formData.append('kalemId', kalemSatirId);

      await fetch('/evrak', { method: 'POST', body: formData });

      evrakGuncelleDinamik(alanAdi, kalemSatirId);

      dosyaInput.value = "";
      aciklamaInput.value = "";
      hideLoader();

      if (this && typeof this.reset === 'function') this.reset();
    });
  }

  document.getElementById('daireSecBtn').onclick = function() {
    window.location.href = `/draw?projectName=${encodeURIComponent(projectName)}`;
  };

  let paraListesi = [];
  let anaTip = null;

  const anaParaCevap = await readAnaPara();

  if (
    anaParaCevap && anaParaCevap.success &&
    Array.isArray(anaParaCevap.anaPara) &&
    anaParaCevap.anaPara.length > 0
  ) {
    // EÄŸer ana para kaydÄ± varsa
    const anaKayit = {
      type: anaParaCevap.anaPara[0].tip,
      tutar: Number(anaParaCevap.anaPara[0].tutar),
      ana: true
    };
    paraListesi.push(anaKayit);
    anaTip = anaKayit.type;

    // ALT PARALARI DB'DEN GETÄ°R VE GÃ–STER
    const altParaCevap = await readAltPara();
    if (
      altParaCevap && altParaCevap.success &&
      Array.isArray(altParaCevap.altPara) &&
      altParaCevap.altPara.length > 0
    ) {
      altParaCevap.altPara.forEach(rec => {
        paraListesi.push({
          type: rec.tip,
          tutar: Number(rec.tutar),
          aciklama: rec.aciklama,
          tarih: rec.tarih,
          ana: false,
          _id: rec._id  // id eksik olmasÄ±n!
        });
      });
    }

    updateParaOzet();
    // Ã¶nce paraAlanContainer'Ä± detay paneli iÃ§in hazÄ±rla
    document.getElementById("paraAlanContainer").innerHTML = `<div id="detayKayitPanel"></div>`;
    detayKayitPaneli();
    return;
  }

  // Ana para kaydÄ± yoksa Ã¶nce giriÅŸ panelini ve detay paneli alanÄ±nÄ± gÃ¶ster
  anaKayitPaneli();

  // ----------------- ALT FONKSÄ°YONLAR -----------------

  function updateParaOzet() {
    const ozet = document.getElementById("paraOzetAlani");
    const liste = document.getElementById("listeOzet");
    const tumSilBtn = document.getElementById("tumKayitlariSilBtn");
    const toplamTutarAlani = document.getElementById("toplamTutarAlani");
    const kalanTutarAlani = document.getElementById("kalanTutarAlani");

    if (!paraListesi.length) {
      ozet.style.display = "none";
      if (tumSilBtn) tumSilBtn.style.display = "none";
      if (toplamTutarAlani) toplamTutarAlani.style.display = "none";
      if (kalanTutarAlani) kalanTutarAlani.style.display = "none";
      return;
    }
    ozet.style.display = "";
    liste.innerHTML = "";

    const toplam = paraListesi
      .filter(p => p.ana === false)
      .reduce((sum, p) => sum + (Number(p.tutar) || 0), 0);

    const anaKayit = paraListesi.find(p => p.ana === true);
    const anaTipLocal = anaKayit ? anaKayit.type : null;
    const anaTutarLocal = anaKayit ? Number(anaKayit.tutar) : null;

    paraListesi.forEach((p, idx) => {
      const aciklamaStr = p.aciklama ? `, AÃ§Ä±klama: ${p.aciklama}` : '';
      const tarihStr = p.tarih ? `, Tarih: ${p.tarih}` : '';
      let satir = '';

      if (p.ana) {
        satir = `<b>${p.type === "alinacak" ? "AlÄ±nacak" : "Verilecek"} Para (ana): ${Number(p.tutar).toLocaleString()} TL</b>`;
        const li = document.createElement("li");
        li.innerHTML = satir;
        liste.appendChild(li);
      } else if (p._id) {
        // Responsive list item: mobilde alt alta, masaÃ¼stÃ¼nde yan yana
        const detayEtiket = p.type === "alinacak" ? "AlÄ±nan" : "Verilen";
        satir = `${detayEtiket} Para: ${Number(p.tutar).toLocaleString()} TL${aciklamaStr}${tarihStr}`;
        const li = document.createElement("li");
        li.className = "row g-2 align-items-center mb-2";

        li.innerHTML = `
          <div class="col-12 col-md-8">
            <span>${satir}</span>
          </div>
          <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
            <button type="button" class="btn btn-danger btn-sm buton-sil-altpara px-3"
              title="Sil" data-satir-index="${idx}" data-altpara-id="${p._id}">
              <i class="fa fa-trash"></i> Sil
            </button>
          </div>
        `;
        liste.appendChild(li);
      }
    });

    // Sil butonlarÄ±na event atamalarÄ±
    liste.querySelectorAll('button[data-satir-index]').forEach(b => {
      b.onclick = async function () {
        const index = parseInt(this.getAttribute('data-satir-index'));
        const altParaId = this.getAttribute('data-altpara-id');
        const userConfirm = await showWarningMessage("KayÄ±t silinsin mi?", "evet", false);
        if (!userConfirm) return;
        if (!isNaN(index)) {
          // Sadece DB'den gelmiÅŸ bir alt para ise silmeye Ã§alÄ±ÅŸ!
          if (altParaId) {
            if (userConfirm) {
              showLoader();
              const response = await fetch('/evrak', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  process: "deleteAltPara",
                  userId,
                  projectName,
                  altParaId
                })
              });
              const resData = await response.json();
              if (resData.success) {
                // Frontend'den de kaldÄ±r
                paraListesi.splice(index, 1);
                updateParaOzet();
                hideLoader();
              } else {
                showWarningMessage("Silme iÅŸlemi baÅŸarÄ±sÄ±z!", "tamam", false);
              }
            }
          } else {
            // HenÃ¼z DB'ye gitmemiÅŸ, frontend'de eklenen silinirse:
            paraListesi.splice(index, 1);
            updateParaOzet();
          }
        }
      };
    });

    if (tumSilBtn) {
      tumSilBtn.style.display = paraListesi.length > 0 ? "" : "none";
      tumSilBtn.onclick = async function () {
        const userConfirm = await showWarningMessage("KayÄ±t silinsin mi?", "evet", false);
        if (!userConfirm) return;
        if (userConfirm) {
          await deleteAnaPara();
          paraListesi = [];
          anaTip = null;
          updateParaOzet();
          anaKayitPaneli();
        }
      };
    }
    if (toplamTutarAlani) {
      toplamTutarAlani.textContent = `Toplam: ${toplam.toLocaleString()} TL`;
      toplamTutarAlani.style.display = "";
    }
    if (kalanTutarAlani) {
      if (anaTutarLocal !== null && anaTipLocal) {
        const kalan = anaTutarLocal - toplam;
        kalanTutarAlani.textContent = `Kalan: ${kalan.toLocaleString()} TL`;
        kalanTutarAlani.style.display = "";
      } else {
        kalanTutarAlani.style.display = "none";
      }
    }
  }

  function anaKayitPaneli() {
    document.getElementById("paraAlanContainer").innerHTML = `
      <div id="anaParaSatiri" class="row align-items-end mb-3 gy-2">
        <div class="col-12 col-md-5">
          <select id="anaParaTipi" class="form-select">
            <option value="alinacak">AlÄ±nacak Para</option>
            <option value="verilecek">Verilecek Para</option>
          </select>
        </div>
        <div class="col-12 col-md-5">
          <input type="text" id="anaParaTutari" class="form-control" min="0" placeholder="Ana Tutar">
        </div>
        <div class="col-12 col-md-2">
          <button type="button" id="anaParaEkleBtn" class="btn btn-success w-100" disabled>Ekle</button>
        </div>
      </div>
      <div id="detayKayitPanel"></div>
    `;

    const ekleBtn = document.getElementById("anaParaEkleBtn");
    const tutarInput = document.getElementById("anaParaTutari");

    // Format fonksiyonu: girilen deÄŸeri 3 lÃ¼ gruplarla nokta ile ayÄ±r
    function formatNumberWithDots(value) {
      const num = value.replace(/[^\d]/g, ''); // Sadece rakamlarÄ± al
      if (!num) return '';
      return num.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    tutarInput.addEventListener('input', function () {
      const raw = this.value.replace(/\./g, '');
      this.value = formatNumberWithDots(raw);
      ekleBtn.disabled = !(raw && !isNaN(raw) && Number(raw) > 0);
      // Ä°mleci sona al:
      this.selectionStart = this.selectionEnd = this.value.length;
    });

    ekleBtn.onclick = async function () {
      const tip = document.getElementById("anaParaTipi").value;
      // NoktalarÄ± kaldÄ±rarak sayÄ±ya Ã§evir!
      const tutar = tutarInput.value.replace(/\./g, '').trim();
      if (!tutar || isNaN(tutar) || Number(tutar) <= 0) return;
      const data = {
        tip,
        tutar: Number(tutar)
      };

      await saveAnaPara(data);

      paraListesi.push({ type: tip, tutar: Number(tutar), ana: true });
      anaTip = tip;
      updateParaOzet();

      document.getElementById("anaParaSatiri").innerHTML = `
        <div class="alert alert-info mb-2">Ana kayÄ±t eklendi: ${tip === "alinacak" ? "AlÄ±nacak" : "Verilecek"} Para, ${Number(tutar).toLocaleString()} TL</div>
      `;
      detayKayitPaneli();
    };
  }
  function detayKayitPaneli() {
    const detayDiv = document.getElementById("detayKayitPanel");
    if (!detayDiv) return;
    detayDiv.innerHTML = `
      <div class="row align-items-end mb-3 gy-2" id="ekSatir">
        <div class="col-12 col-md-4">
          <input type="text" id="paraAciklama" class="form-control" maxlength="100" placeholder="AÃ§Ä±klama (opsiyonel)">
        </div>
        <div class="col-12 col-md-3">
          <input type="text" id="paraDetayTutar" class="form-control" placeholder="Tutar">
        </div>
        <div class="col-12 col-md-3">
          <input type="date" id="paraTarih" class="form-control" value="${new Date().toISOString().split('T')[0]}">
        </div>
        <div class="col-12 col-md-2">
          <button type="button" id="ekBilgiKaydetBtn" class="btn btn-primary w-100">Kaydet</button>
        </div>
      </div>
    `;

    // Binlik noktalama fonksiyonu
    function formatNumberWithDots(value) {
      const num = value.replace(/[^\d]/g, '');
      if (!num) return '';
      return num.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // Tutar inputuna dinamik noktalamayÄ± uygula
    const tutarInput = document.getElementById("paraDetayTutar");
    tutarInput.addEventListener('input', function () {
      const raw = this.value.replace(/\./g, '');
      this.value = formatNumberWithDots(raw);
      this.selectionStart = this.selectionEnd = this.value.length; // imleci sona al
    });

    document.getElementById("ekBilgiKaydetBtn").onclick = async function () {
      const aciklama = document.getElementById("paraAciklama").value.trim();
      const tutar = tutarInput.value.replace(/\./g, '').trim(); // NoktalarÄ± kaldÄ±r, ham sayÄ± al
      const tarih = document.getElementById("paraTarih").value;
      if (!tutar || isNaN(tutar) || Number(tutar) <= 0) {
        showWarningMessage("Tutar giriniz.", "tamam", false);
        return;
      }
      if (!aciklama) {
        showWarningMessage("AÃ§Ä±klama giriniz.", "tamam", false);
        return;
      }
      const data = {
        tip: anaTip,
        tutar: Number(tutar),
        aciklama: aciklama,
        tarih: tarih
      };

      const saveRes = await saveAltPara(data);
      if (saveRes && saveRes.success && saveRes.altPara && saveRes.altPara._id) {
        paraListesi.push({
          type: saveRes.altPara.tip,
          tutar: Number(saveRes.altPara.tutar),
          aciklama: saveRes.altPara.aciklama,
          tarih: saveRes.altPara.tarih,
          ana: false,
          _id: saveRes.altPara._id
        });
        updateParaOzet();
        document.getElementById("paraAciklama").value = "";
        tutarInput.value = "";
        document.getElementById("paraTarih").value = new Date().toISOString().split('T')[0];
      } else {
        showWarningMessage("KayÄ±t eklenemedi, tekrar deneyin!", "tamam", false);
      }
    };
  }
}


async function saveAnaPara(data){
  showLoader();
      fetch('/evrak', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            process: "saveAnaPara",
            userId,
            projectName,
            tip: data.tip,
            tutar: data.tutar
          })
        })
      .then(r => r.json())
      .finally(() => {
        hideLoader();
    });
}
async function readAnaPara(){
  showLoader();
    try {
      const response = await fetch('/evrak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          process: "readAnaPara",
          userId,
          projectName
        })
      });
      const data = await response.json();
      return data;
    } finally {
      hideLoader();
    }
}
async function deleteAnaPara(){
  showLoader();
  try {
    const response = await fetch('/evrak', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        process: "deleteAnaPara",
        userId,
        projectName
      })
    });
    const resData = await response.json();
    return resData;
  } finally {
    hideLoader();
  }
}
async function saveAltPara(data) {
  showLoader();
  try {
    const response = await fetch('/evrak', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        process: "saveAltPara",
        userId,
        projectName,
        tip: data.tip,
        tutar: data.tutar,
        tarih: data.tarih,
        aciklama: data.aciklama
      })
    });
    const resData = await response.json();
    return resData;
  } finally {
    hideLoader();
  }
}
async function readAltPara(){
  showLoader();
    try {
      const response = await fetch('/evrak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          process: "readAltPara",
          userId,
          projectName
        })
      });
      const data = await response.json();
      return data; // backend'den gelen obje: {success: true, anaPara: [...]}
    } finally {
      hideLoader();
    }
}

async function readYerSahibi(){
  showLoader();
    try {
      const response = await fetch('/evrak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          process: "readYerSahibi",
          userId,
          projectName
        })
      });
      const data = await response.json();
      //console.log("data:",data);
      return data;
    } finally {
      hideLoader();
    }
}


async function showKenselDonusumModal(
  isRadyal = false, isEvrakIsleri = false, geriHandler = null, altKalemId = null, kayitDizisi = null, kalemIdInput
) {
  let alanAciklamasi = '';
  aktifKalemId = altKalemId;
  kalemId = kalemIdInput;
  if (isEvrakIsleri) {
    alanAciklamasi = `<div class="alert alert-info py-2 mb-2"> <b>${aktifEvrakKurum} - ${aktifEvrakDetay}</b> iÅŸlemi iÃ§in Ã¶deme ve evrak ekleyin.</div>`;
  }
  kayitDizisi = kayitDizisi || "";
  let secilenKalem = null;
  if (Array.isArray(kayitDizisi)) {
    secilenKalem = kayitDizisi.find(x => x.id === altKalemId);
  }
  const birimListesi =
    secilenKalem && secilenKalem.birimler ? secilenKalem.birimler : ["adet"];

  document.getElementById('modalContentGenel').innerHTML = `  
    <h5>Kentsel DÃ¶nÃ¼ÅŸÃ¼m AnlaÅŸmalarÄ±</h5>  
    <div style="color: #6c757d; font-size: 0.98em; margin-bottom:18px;">  
      Kentsel DÃ¶nÃ¼ÅŸÃ¼m kapsamÄ±nda para alma/verme Ã¼zerine anlaÅŸÄ±lmÄ±ÅŸsa ilgili yerlere giriniz.  
    </div>  
    <div id="paraOzetAlani" class="alert alert-secondary py-2 mb-3" style="display:none;">  
      <b>Girilen Bilgiler:</b>  
      <ul class="list-unstyled mb-0" id="listeOzet"></ul>  
      <div class="d-flex justify-content-between align-items-center gap-2 mt-2 flex-wrap">  
        <div>  
          <span id="toplamTutarAlani" class="fw-bold text-primary" style="display:none;">Toplam: 0 TL</span>  
          <span id="kalanTutarAlani" class="fw-bold text-success" style="display:none; margin-left:12px;">Kalan: 0 TL</span>  
        </div>  
        <button type="button" id="tumKayitlariSilBtn" class="btn btn-outline-danger btn-sm" style="display:none;">TÃ¼m KayÄ±tlarÄ± Sil</button>  
      </div>  
    </div>  
    <div id="paraAlanContainer"></div>    

    <hr class="my-3" style="border-color: #cbd5e1; border-width: 4.5px 0 0 0; opacity:.88;" />  
    <div class="card shadow-sm mb-0 w-100 mt-4 mb-3">  
      <div class="card-header bg-light">  
        <b class="text-primary"><i class="fa-solid fa-paperclip"></i> Evrak YÃ¼kle</b>  
      </div>  
      <div class="card-body pt-3 pb-2">  
        <form id="evrakFormDinamik" data-alanadi="kentselDonusum" data-kalemid="Kentsel DÃ¶nÃ¼ÅŸÃ¼m">  
          <div class="input-group mb-2">  
            <input type="file" class="form-control" id="evrakDosya" name="file" required>  
          </div>  
          <div class="mb-2">  
            <input type="text" class="form-control" id="evrakAciklama" maxlength="100" placeholder="AÃ§Ä±klama (opsiyonel)">  
          </div>  
          <div class="d-flex justify-content-end">  
            <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-upload"></i> YÃ¼kle</button>  
          </div>  
        </form>  
        <hr>  
        <div>  
          <h6 class="mb-1 text-secondary">YÃ¼klenen Evraklar:</h6>  
          <ul class="list-group file-list" id="evrakListesi" style="font-size:0.97rem;"></ul>  
        </div>  
      </div>  
    </div>  
  `;

  evrakGuncelleDinamik("kentselDonusum", "Kentsel DÃ¶nÃ¼ÅŸÃ¼m");

  const evrakForm = document.getElementById('evrakFormDinamik');
  if (evrakForm) {
    const thisProjectName = projectName;
    const thisUserId = userId;

    evrakForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const form = e.target;
      const alanAdi = form.dataset.alanadi;
      const kalemSatirId = form.dataset.kalemid;
      const dosyaInput = document.getElementById('evrakDosya');
      const aciklamaInput = document.getElementById('evrakAciklama');
      const dosya = dosyaInput.files[0];
      if (!dosya) return;

      const aciklama = aciklamaInput.value.trim();

      let pdfFile;
      try {
        pdfFile = await fileToPdfBlob(dosya);
      } catch(e) {
        dosyaInput.value = "";
        aciklamaInput.value = "";
        showWarningMessage("Dosya PDF veya resim deÄŸil!", "tamam", false);
        return;
      }

      showLoader();

      const formData = new FormData();
      formData.append('file', pdfFile);
      formData.append('aciklama', aciklama);
      formData.append('process', "saveEvrak");
      formData.append('projectName', thisProjectName);
      formData.append('userId', thisUserId);
      formData.append('alanAdi', alanAdi);
      if (kalemSatirId) formData.append('kalemId', kalemSatirId);

      await fetch('/evrak', { method: 'POST', body: formData });

      evrakGuncelleDinamik(alanAdi, kalemSatirId);

      dosyaInput.value = "";
      aciklamaInput.value = "";
      hideLoader();

      if (this && typeof this.reset === 'function') this.reset();
    });
  }

  let paraListesi = [];
  let anaTip = null;

  const anaParaKentselCevap = await readAnaParaKentsel();
  if (
    anaParaKentselCevap && anaParaKentselCevap.success &&
    Array.isArray(anaParaKentselCevap.anaParaKentsel) &&
    anaParaKentselCevap.anaParaKentsel.length > 0
  ) {
    // EÄŸer para al kaydÄ± varsa
    const anaKayit = {
      type: anaParaKentselCevap.anaParaKentsel[0].tip,
      tutar: Number(anaParaKentselCevap.anaParaKentsel[0].tutar),
      ana: true
    };
    paraListesi.push(anaKayit);
    anaTip = anaKayit.type;

    // EÄŸer para ver kaydÄ± varsa
    const altParaKentselCevap = await readAltParaKentsel();
    if (
      altParaKentselCevap && altParaKentselCevap.success &&
      Array.isArray(altParaKentselCevap.altParaKentsel) &&
      altParaKentselCevap.altParaKentsel.length > 0
    ) {
      altParaKentselCevap.altParaKentsel.forEach(rec => {
        paraListesi.push({
          type: rec.tip,
          tutar: Number(rec.tutar),
          aciklama: rec.aciklama,
          tarih: rec.tarih,
          ana: false,
          _id: rec._id  // id eksik olmasÄ±n!
        });
      });
    }

    updateParaOzetKentsel();
    // Ã¶nce paraAlanContainer'Ä± detay paneli iÃ§in hazÄ±rla
    document.getElementById("paraAlanContainer").innerHTML = `<div id="detayKayitPanel"></div>`;
    detayKayitPaneliKentsel();
    return;
  }
  

  // Ana para kaydÄ± yoksa Ã¶nce giriÅŸ panelini ve detay paneli alanÄ±nÄ± gÃ¶ster
  anaKayitPaneliKentsel();

  // ----------------- ALT FONKSÄ°YONLAR -----------------

  function updateParaOzetKentsel() {
    const ozet = document.getElementById("paraOzetAlani");
    const liste = document.getElementById("listeOzet");
    const tumSilBtn = document.getElementById("tumKayitlariSilBtn");
    const toplamTutarAlani = document.getElementById("toplamTutarAlani");
    const kalanTutarAlani = document.getElementById("kalanTutarAlani");

    if (!paraListesi.length) {
      ozet.style.display = "none";
      if (tumSilBtn) tumSilBtn.style.display = "none";
      if (toplamTutarAlani) toplamTutarAlani.style.display = "none";
      if (kalanTutarAlani) kalanTutarAlani.style.display = "none";
      return;
    }
    ozet.style.display = "";
    liste.innerHTML = "";

    const toplam = paraListesi
      .filter(p => p.ana === false)
      .reduce((sum, p) => sum + (Number(p.tutar) || 0), 0);

    const anaKayit = paraListesi.find(p => p.ana === true);
    const anaTipLocal = anaKayit ? anaKayit.type : null;
    const anaTutarLocal = anaKayit ? Number(anaKayit.tutar) : null;

    paraListesi.forEach((p, idx) => {
      const aciklamaStr = p.aciklama ? `, AÃ§Ä±klama: ${p.aciklama}` : '';
      const tarihStr = p.tarih ? `, Tarih: ${p.tarih}` : '';
      let satir = '';

      if (p.ana) {
        satir = `<b>${p.type === "alinacak" ? "AlÄ±nacak" : "Verilecek"} Para (ana): ${Number(p.tutar).toLocaleString()} TL</b>`;
        const li = document.createElement("li");
        li.innerHTML = satir;
        liste.appendChild(li);
      } else if (p._id) {
        // Responsive list item: mobilde alt alta, masaÃ¼stÃ¼nde yan yana
        const detayEtiket = p.type === "alinacak" ? "AlÄ±nan" : "Verilen";
        satir = `${detayEtiket} Para: ${Number(p.tutar).toLocaleString()} TL${aciklamaStr}${tarihStr}`;
        const li = document.createElement("li");
        li.className = "row g-2 align-items-center mb-2";

        li.innerHTML = `
          <div class="col-12 col-md-8">
            <span>${satir}</span>
          </div>
          <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
            <button type="button" class="btn btn-danger btn-sm buton-sil-altpara px-3"
              title="Sil" data-satir-index="${idx}" data-altpara-id="${p._id}">
              <i class="fa fa-trash"></i> Sil
            </button>
          </div>
        `;
        liste.appendChild(li);
      }
    });

    // Sil butonlarÄ±na event atamalarÄ±
    liste.querySelectorAll('button[data-satir-index]').forEach(b => {
      b.onclick = async function () {
        const index = parseInt(this.getAttribute('data-satir-index'));
        const altParaId = this.getAttribute('data-altpara-id');
        const userConfirm = await showWarningMessage("KayÄ±t silinsin mi?", "evet", false);
        if (!userConfirm) return;
        if (!isNaN(index)) {
          // Sadece DB'den gelmiÅŸ bir alt para ise silmeye Ã§alÄ±ÅŸ!
          if (altParaId) {
            if (userConfirm) {
              showLoader();
              const response = await fetch('/evrak', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  process: "deleteAltParaKentsel",
                  userId,
                  projectName,
                  altParaId
                })
              });
              const resData = await response.json();
              if (resData.success) {
                // Frontend'den de kaldÄ±r
                paraListesi.splice(index, 1);
                updateParaOzetKentsel();
                hideLoader();
              } else {
                showWarningMessage("Silme iÅŸlemi baÅŸarÄ±sÄ±z!", "tamam", false);
              }
            }
          } else {
            // HenÃ¼z DB'ye gitmemiÅŸ, frontend'de eklenen silinirse:
            paraListesi.splice(index, 1);
            updateParaOzetKentsel();
          }
        }
      };
    });

    if (tumSilBtn) {
      tumSilBtn.style.display = paraListesi.length > 0 ? "" : "none";
      tumSilBtn.onclick = async function () {
        const userConfirm = await showWarningMessage("KayÄ±t silinsin mi?", "evet", false);
        if (!userConfirm) return;
        if (userConfirm) {
          await deleteAnaParaKentsel();
          paraListesi = [];
          anaTip = null;
          updateParaOzetKentsel();
          anaKayitPaneliKentsel();
        }
      };
    }
    if (toplamTutarAlani) {
      toplamTutarAlani.textContent = `Toplam: ${toplam.toLocaleString()} TL`;
      toplamTutarAlani.style.display = "";
    }
    if (kalanTutarAlani) {
      if (anaTutarLocal !== null && anaTipLocal) {
        const kalan = anaTutarLocal - toplam;
        kalanTutarAlani.textContent = `Kalan: ${kalan.toLocaleString()} TL`;
        kalanTutarAlani.style.display = "";
      } else {
        kalanTutarAlani.style.display = "none";
      }
    }
  }

  function anaKayitPaneliKentsel() {
  document.getElementById("paraAlanContainer").innerHTML = `
    <div id="anaParaSatiri" class="row align-items-end mb-3 gy-2">
      <div class="col-12 col-md-5">
        <select id="anaParaTipi" class="form-select">
          <option value="alinacak">AlÄ±nacak Para</option>
          <option value="verilecek">Verilecek Para</option>
        </select>
      </div>
      <div class="col-12 col-md-5">
        <input type="text" id="anaParaTutari" class="form-control" placeholder="Ana Tutar">
      </div>
      <div class="col-12 col-md-2">
        <button type="button" id="anaParaEkleBtn" class="btn btn-success w-100" disabled>Ekle</button>
      </div>
    </div>
    <div id="detayKayitPanel"></div>
  `;

  const ekleBtn = document.getElementById("anaParaEkleBtn");
  const tutarInput = document.getElementById("anaParaTutari");

  // 3'lÃ¼ gruplara nokta koyan fonksiyon
  function formatNumberWithDots(value) {
    const num = value.replace(/[^\d]/g, ''); // Sadece rakamlarÄ± al
    if (!num) return '';
    return num.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }

  tutarInput.addEventListener('input', function () {
    const raw = this.value.replace(/\./g, ''); // NoktalarÄ± kaldÄ±r, sadece rakamlar kalsÄ±n
    this.value = formatNumberWithDots(raw);    // FormatlÄ± olarak geri yaz
    ekleBtn.disabled = !(raw && !isNaN(raw) && Number(raw) > 0);
    // Ä°mleci sona al:
    this.selectionStart = this.selectionEnd = this.value.length;
  });

  ekleBtn.onclick = async function () {
    const tip = document.getElementById("anaParaTipi").value;
    // NoktalarÄ± kaldÄ±rarak sayÄ±ya Ã§evir!
    const tutar = tutarInput.value.replace(/\./g, '').trim();
    if (!tutar || isNaN(tutar) || Number(tutar) <= 0) return;
    const data = {
      tip,
      tutar: Number(tutar)
    };

    await saveAnaParaKentsel(data);

    paraListesi.push({ type: tip, tutar: Number(tutar), ana: true });
    anaTip = tip;
    updateParaOzetKentsel();

    document.getElementById("anaParaSatiri").innerHTML = `
      <div class="alert alert-info mb-2">Ana kayÄ±t eklendi: ${tip === "alinacak" ? "AlÄ±nacak" : "Verilecek"} Para, ${Number(tutar).toLocaleString()} TL</div>
    `;
    detayKayitPaneliKentsel();
  };
}

  function detayKayitPaneliKentsel() {
    const detayDiv = document.getElementById("detayKayitPanel");
    if (!detayDiv) return;
    detayDiv.innerHTML = `
      <div class="row align-items-end mb-3 gy-2" id="ekSatir">
        <div class="col-12 col-md-4">
          <input type="text" id="paraAciklama" class="form-control" maxlength="100" placeholder="AÃ§Ä±klama (opsiyonel)">
        </div>
        <div class="col-12 col-md-3">
          <input type="text" id="paraDetayTutar" class="form-control" placeholder="Tutar">
        </div>
        <div class="col-12 col-md-3">
          <input type="date" id="paraTarih" class="form-control" value="${new Date().toISOString().split('T')[0]}">
        </div>
        <div class="col-12 col-md-2">
          <button type="button" id="ekBilgiKaydetBtn" class="btn btn-primary w-100">Kaydet</button>
        </div>
      </div>
    `;

    const tutarInput = document.getElementById("paraDetayTutar");
    // Noktalama fonksiyonu (binlik ayÄ±rÄ±cÄ±)
    function formatNumberWithDots(value) {
      const num = value.replace(/[^\d]/g, ''); // Sadece rakamlar
      if (!num) return '';
      return num.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    tutarInput.addEventListener("input", function () {
      const raw = this.value.replace(/\./g, '');
      this.value = formatNumberWithDots(raw);
      this.selectionStart = this.selectionEnd = this.value.length; // imleci sona al
    });

    document.getElementById("ekBilgiKaydetBtn").onclick = async function () {
      const aciklama = document.getElementById("paraAciklama").value.trim();
      // NoktalarÄ± kaldÄ±r, sayÄ± olarak oku:
      const tutar = tutarInput.value.replace(/\./g, '').trim();
      const tarih = document.getElementById("paraTarih").value;
      if (!tutar || isNaN(tutar) || Number(tutar) <= 0) {
        showWarningMessage("Tutar giriniz.", "tamam", false);
        return;
      }
      if (!aciklama) {
        showWarningMessage("AÃ§Ä±klama giriniz.", "tamam", false);
        return;
      }
      const data = {
        tip: anaTip,
        tutar: Number(tutar),
        aciklama: aciklama,
        tarih: tarih
      };

      const saveRes = await saveAltParaKentsel(data);
      if (saveRes && saveRes.success && saveRes.altParaKentsel && saveRes.altParaKentsel._id) {
        paraListesi.push({
          type: saveRes.altParaKentsel.tip,
          tutar: Number(saveRes.altParaKentsel.tutar),
          aciklama: saveRes.altParaKentsel.aciklama,
          tarih: saveRes.altParaKentsel.tarih,
          ana: false,
          _id: saveRes.altParaKentsel._id
        });
        updateParaOzetKentsel();
        document.getElementById("paraAciklama").value = "";
        tutarInput.value = "";
        document.getElementById("paraTarih").value = new Date().toISOString().split('T')[0];
      } else {
        showWarningMessage("KayÄ±t eklenemedi, tekrar deneyin!", "tamam", false);
      }
    };
  }
}

async function saveAnaParaKentsel(data){
  showLoader();
  fetch('/evrak', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        process: "saveAnaParaKentsel",
        userId,
        projectName,
        tip: data.tip,
        tutar: data.tutar
      })
    })
    .then(r => r.json())
    .finally(() => {
      hideLoader();
  });
}
async function readAnaParaKentsel(){
  showLoader();
    try {
      const response = await fetch('/evrak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          process: "readAnaParaKentsel",
          userId,
          projectName
        })
      });
      const data = await response.json();
      return data;
    } finally {
      hideLoader();
    }
}
async function readAltParaKentsel(){
  showLoader();
    try {
      const response = await fetch('/evrak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          process: "readAltParaKentsel",
          userId,
          projectName
        })
      });
      const data = await response.json();
      return data; // backend'den gelen obje: {success: true, anaPara: [...]}
    } finally {
      hideLoader();
    }
}
async function deleteAnaParaKentsel(){
  showLoader();
  try {
    const response = await fetch('/evrak', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        process: "deleteAnaParaKentsel",
        userId,
        projectName
      })
    });
    const resData = await response.json();
    return resData;
  } finally {
    hideLoader();
  }
}
async function saveAltParaKentsel(data) {
  showLoader();
  try {
    const response = await fetch('/evrak', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        process: "saveAltParaKentsel",
        userId,
        projectName,
        tip: data.tip,
        tutar: data.tutar,
        tarih: data.tarih,
        aciklama: data.aciklama
      })
    });
    const resData = await response.json();
    return resData;
  } finally {
    hideLoader();
  }
}

window.silEvrakSunucu = silEvrakSunucu;
window.evrakGuncelleDinamik = evrakGuncelleDinamik;
window.showEvrakModal = showEvrakModal;
window.showKenselDonusumModal = showKenselDonusumModal;



    /*
    quatationButton.addEventListener("click", () => {
        window.location.href = `/quatation?projectName=${encodeURIComponent(projectName)}`;
    });
    */
    graphsButton.addEventListener("click", () => {
        window.location.href = `/analiz?projectName=${encodeURIComponent(projectName)}`;
    });
    soldButton.addEventListener("click", () => {
        window.location.href = `/sold?projectName=${encodeURIComponent(projectName)}`;
    });
    material.addEventListener("click", () => {
        window.location.href = `/malzeme?projectName=${encodeURIComponent(projectName)}`;
    });
    buttonHome.addEventListener("click", () => {  
        window.location.href = `/draw?projectName=${encodeURIComponent(projectName)}`;
    });
    loginButton.addEventListener("click", () => {
        window.location.href = "/";
    });
    approvedButton.addEventListener("click", () => {
        window.location.href = `/approved?projectName=${encodeURIComponent(projectName)}`;
    });

    function showLoader() {
        document.getElementById('loader').style.display = 'flex';
    }
    function hideLoader() {
        document.getElementById('loader').style.display = 'none';
    }

    function formatNumberWithDots(value) {
      value = value.trim();

      let [tamKisim, ondalikKisim] = value.split(',');
      tamKisim = tamKisim ? tamKisim.replace(/[^\d]/g, '') : '';

      if (tamKisim.length > 0) {
        tamKisim = tamKisim.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
      if (typeof ondalikKisim !== 'undefined') {
        ondalikKisim = ondalikKisim.replace(/[^\d]/g, '');
        return tamKisim + ',' + ondalikKisim;
      } else {
        return tamKisim;
      }
    }
    function toNumberFromInput(str) {
      // Binlik noktalarÄ±nÄ± kaldÄ±r
      let s = str.replace(/\./g, '');
      // OndalÄ±k virgÃ¼lÃ¼ noktaya Ã§evir
      s = s.replace(/,/g, '.');
      return Number(s) || 0;
    }

</script>
</body>
</html>